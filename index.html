<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Libre+Baskerville:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --accent-color: #6366f1;
            --accent-hover: #5855eb;
            --accent-light: #eef2ff;
            --body-font: 'Inter', sans-serif;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            background: var(--bg-primary);
            font-family: var(--body-font);
        }

        /* Modern Card Styles */
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card.premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .card.premium .card-title,
        .card.premium .card-subtitle {
            color: white;
        }

        .card-header {
            padding: 24px 28px 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px 16px 0 0;
        }

        .card-content {
            padding: 24px 28px;
        }

        .card.premium .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
        }

        /* Modern Form Inputs */
        .form-input {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .form-input::placeholder {
            color: #94a3b8;
        }

        /* Modern Buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5855eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Template Selection */
        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .template-option {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            background: white;
        }

        .template-option:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-sm);
        }

        .template-option.selected {
            border-color: var(--accent-color);
            background: rgb(99 102 241 / 0.05);
        }

        .template-preview {
            width: 100%;
            height: 80px;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        /* Drag and Drop */
        .sortable-ghost {
            opacity: 0.4;
        }

        .sortable-chosen {
            transform: scale(1.02);
        }

        .drag-handle {
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .section-card:hover .drag-handle {
            opacity: 1;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .flex {
                flex-direction: column;
            }

            aside {
                width: 100% !important;
                max-height: 50vh;
            }

            main {
                width: 100% !important;
            }

            .template-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Keyboard shortcuts indicator */
        .shortcut-hint {
            font-size: 11px;
            color: var(--text-secondary);
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        /* Modern animations */
        @keyframes modal-in {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
        }

        .animate-modal-in {
            animation: modal-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-up {
            animation: slide-up 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Enhanced suggestion cards */
        .suggestion-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .suggestion-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-color);
        }

        .suggestion-card:hover::before {
            opacity: 1;
        }

        .suggestion-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--accent-light);
            color: var(--accent-color);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-tag:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        /* Enhanced progress indicators */
        .progress-ring {
            width: 60px;
            height: 60px;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 4;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-circle.active {
            stroke: var(--accent-color);
        }

        /* Glassmorphism effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }

        /* Enhanced tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        /* Section Cards */
        .section-card {
            margin-bottom: 16px;
        }

        .section-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s ease;
        }

        .section-item:hover {
            border-color: #cbd5e1;
            box-shadow: var(--shadow-sm);
        }

        .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: 2px solid white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Toolbar */
        #toolbar {
            position: absolute;
            display: none;
            background: var(--text-primary);
            border-radius: 8px;
            padding: 8px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        #toolbar button {
            background: none;
            border: none;
            color: white;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        #toolbar button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Resume Preview */
        #resume-preview {
            font-family: var(--body-font);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        #resume-preview a {
            color: var(--accent-color);
            text-decoration: underline;
        }

        #resume-preview .accent-text {
            color: var(--accent-color);
        }

        #resume-container {
            box-sizing: border-box;
        }

        /* Better text wrapping for long content */
        .resume-section {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .resume-section .space-y-3>div {
            word-break: break-word;
            overflow-wrap: break-word;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 1200px) {
            #resume-container {
                width: 100% !important;
                max-width: 100% !important;
                min-height: auto !important;
            }
        }

        /* Ensure proper spacing and layout */
        .resume-section h2 {
            margin-bottom: 1rem;
        }

        .resume-section:last-child {
            margin-bottom: 0;
        }

        /* Fix text overflow in experience items */
        .resume-section .flex {
            align-items: flex-start;
        }

        .resume-section .whitespace-nowrap {
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Template: Modern (Single Column) */
        .template-modern .section-title {
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 2px solid #000;
            letter-spacing: 0.1em;
        }

        .template-modern .company-name {
            font-weight: 600;
        }

        .template-modern .job-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Template: Classic (Two Column) */
        .template-classic {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .template-classic .classic-main {
            grid-column: 2 / 3;
        }

        .template-classic .classic-sidebar {
            grid-column: 1 / 2;
        }

        .template-classic .section-title {
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 1px solid #ccc;
            color: var(--accent-color);
        }

        .template-classic .job-title {
            font-weight: 700;
        }
    </style>
</head>

<body class="overflow-hidden h-screen">
    <div class="flex h-full gap-6 p-6">
        <!-- Left Panel: Form -->
        <aside class="w-1/3 overflow-y-auto">
            <!-- Header Card -->
            <div class="card mb-6">
                <div class="card-header">
                    <h1 class="card-title">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Resume Builder
                    </h1>
                    <p class="card-subtitle">Create your professional resume with AI assistance</p>
                </div>
            </div>

            <!-- Form Container -->
            <div id="form-container" class="space-y-4">
                <!-- JS will generate form sections here -->
            </div>

            <!-- Action Buttons -->
            <!-- Import/Export Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                        </svg>
                        Import & Export
                    </h3>
                </div>
                <div class="card-content space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="import-btn" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10">
                                </path>
                            </svg>
                            Import
                        </button>
                        <button id="save-btn" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12">
                                </path>
                            </svg>
                            Save
                        </button>
                    </div>
                    <button id="download-pdf-btn" class="btn btn-primary w-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download PDF
                        <span class="shortcut-hint">Ctrl+E</span>
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="download-docx-btn" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            DOCX
                        </button>
                        <button id="download-json-btn" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            JSON
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4 space-y-3">
                <button id="add-section-btn" class="btn btn-secondary w-full">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Custom Section
                    <span class="shortcut-hint">Ctrl+N</span>
                </button>
            </div>

            <!-- Hidden file input for import -->
            <input type="file" id="file-input" accept=".json,.docx,.pdf" style="display: none;">
        </aside>

        <!-- Right Panel: Resume Preview -->
        <main class="w-2/3 bg-gray-200 p-4 overflow-y-auto">
            <!-- Preview Controls -->
            <div class="mb-4 flex justify-between items-center">
                <div class="flex gap-2">
                    <button id="preview-desktop" class="btn btn-secondary text-xs active">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                        Desktop
                    </button>
                    <button id="preview-mobile" class="btn btn-secondary text-xs">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 18h.01M8 21h8a1 1 0 001-1V4a1 1 0 00-1-1H8a1 1 0 00-1 1v16a1 1 0 001 1z"></path>
                        </svg>
                        Mobile
                    </button>
                    <button id="preview-print" class="btn btn-secondary text-xs">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                            </path>
                        </svg>
                        Print
                    </button>
                </div>
                <div class="flex gap-2">
                    <button id="zoom-out" class="btn btn-secondary text-xs">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                        </svg>
                    </button>
                    <span id="zoom-level" class="text-xs text-gray-600 px-2 py-1">100%</span>
                    <button id="zoom-in" class="btn btn-secondary text-xs">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Resume Container -->
            <div class="flex justify-center">
                <div id="preview-wrapper" class="transition-all duration-300">
                    <div id="resume-container" class="bg-white shadow-2xl mx-auto"
                        style="width: 210mm; min-height: 297mm; max-width: 100%; padding: 32px;">
                        <div id="resume-preview" class="break-words">
                            <!-- JS will build resume here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Text Formatting Toolbar -->
    <div id="toolbar">
        <button id="bold-btn" title="Bold"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                </path>
            </svg></button>
        <button id="italic-btn" title="Italic"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M14.732 3.224a.75.75 0 00-1.06-.02L6.224 11.232a.75.75 0 00.02 1.06l.04.039a.75.75 0 001.06-.02L14.776 4.28a.75.75 0 00-.04-1.058l-.004-.003zM5.224 11.232a.75.75 0 00-1.06.02L.224 16.72a.75.75 0 00.02 1.06l.04.039a.75.75 0 001.06-.02L5.224 12.28a.75.75 0 00.04-1.058l-.004-.003z">
                </path>
            </svg></button>
        <button id="underline-btn" title="Underline"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M4 15.5a.5.5 0 00.5.5h11a.5.5 0 000-1h-11a.5.5 0 00-.5.5zM4.5 4a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zM7.5 4a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5z">
                </path>
            </svg></button>
        <button id="link-btn" title="Add Link"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0m-4.242 0a2 2 0 010 2.828l-3 3a2 2 0 01-2.828-2.828l3-3a2 2 0 012.828 0z"
                    clip-rule="evenodd"></path>
                <path fill-rule="evenodd"
                    d="M5.172 7.172a2 2 0 012.828 0l4.242 4.242a2 2 0 11-2.828 2.828L5.172 10a2 2 0 010-2.828z"
                    clip-rule="evenodd"></path>
            </svg></button>
    </div>

    <!-- Enhanced AI Analysis Modal -->
    <div id="ai-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="card premium w-full max-w-4xl max-h-[90vh] overflow-hidden animate-modal-in">
            <div class="card-header relative">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">AI Resume Analysis</h3>
                            <p class="text-white text-opacity-80 text-sm">Powered by advanced AI algorithms</p>
                        </div>
                    </div>
                    <button id="close-ai-modal"
                        class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Progress indicator -->
                <div id="analysis-progress" class="hidden mt-4">
                    <div class="flex items-center space-x-2 text-white text-opacity-80">
                        <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                        <span class="text-sm">Analyzing your resume...</span>
                    </div>
                    <div class="mt-2 bg-white bg-opacity-20 rounded-full h-1">
                        <div id="progress-bar" class="bg-white h-1 rounded-full transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card-content bg-white">
                <div id="ai-feedback" class="max-h-96 overflow-y-auto text-sm leading-relaxed">
                    <!-- AI feedback will be inserted here -->
                </div>

                <!-- Action buttons -->
                <div class="mt-6 flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button id="export-analysis" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-4-4m4 4l4-4m-6 4V4"></path>
                            </svg>
                            Export Analysis
                        </button>
                        <button id="reanalyze" class="btn btn-secondary text-xs">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            Re-analyze
                        </button>
                    </div>
                    <button id="apply-all-suggestions" class="btn btn-primary">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Apply All Suggestions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing resume builder...');

            // --- ENHANCED AI SUGGESTIONS DATABASE ---
            const aiSuggestions = {
                actionVerbs: {
                    leadership: ['Spearheaded', 'Orchestrated', 'Championed', 'Pioneered', 'Directed', 'Guided', 'Mentored'],
                    achievement: ['Achieved', 'Exceeded', 'Surpassed', 'Delivered', 'Accomplished', 'Attained', 'Secured'],
                    improvement: ['Optimized', 'Enhanced', 'Streamlined', 'Revolutionized', 'Transformed', 'Modernized', 'Upgraded'],
                    creation: ['Developed', 'Designed', 'Built', 'Created', 'Established', 'Launched', 'Implemented'],
                    collaboration: ['Collaborated', 'Partnered', 'Coordinated', 'Facilitated', 'United', 'Aligned', 'Engaged'],
                    analysis: ['Analyzed', 'Evaluated', 'Assessed', 'Investigated', 'Researched', 'Examined', 'Diagnosed']
                },
                skills: {
                    'software engineer': {
                        technical: ['JavaScript', 'Python', 'React', 'Node.js', 'TypeScript', 'GraphQL', 'Docker', 'Kubernetes'],
                        cloud: ['AWS', 'Azure', 'GCP', 'Serverless', 'Microservices', 'CI/CD', 'DevOps'],
                        databases: ['PostgreSQL', 'MongoDB', 'Redis', 'Elasticsearch', 'SQL', 'NoSQL'],
                        trending: ['Next.js', 'Rust', 'Go', 'WebAssembly', 'Machine Learning', 'Blockchain']
                    },
                    'product manager': {
                        methodology: ['Agile', 'Scrum', 'Kanban', 'Lean', 'Design Thinking', 'OKRs'],
                        analytics: ['Google Analytics', 'Mixpanel', 'Amplitude', 'A/B Testing', 'SQL', 'Tableau'],
                        tools: ['Jira', 'Confluence', 'Figma', 'Miro', 'Slack', 'Notion'],
                        skills: ['Roadmapping', 'Stakeholder Management', 'User Research', 'Market Analysis']
                    },
                    'data scientist': {
                        languages: ['Python', 'R', 'SQL', 'Scala', 'Julia', 'MATLAB'],
                        ml: ['Machine Learning', 'Deep Learning', 'NLP', 'Computer Vision', 'MLOps'],
                        tools: ['TensorFlow', 'PyTorch', 'Scikit-learn', 'Pandas', 'NumPy', 'Jupyter'],
                        visualization: ['Tableau', 'Power BI', 'Matplotlib', 'Seaborn', 'D3.js', 'Plotly']
                    }
                },
                industryKeywords: {
                    'fintech': ['blockchain', 'cryptocurrency', 'payment processing', 'regulatory compliance', 'risk management'],
                    'healthcare': ['HIPAA', 'clinical trials', 'patient care', 'medical devices', 'telemedicine'],
                    'e-commerce': ['conversion optimization', 'customer acquisition', 'inventory management', 'marketplace'],
                    'saas': ['subscription model', 'customer success', 'churn reduction', 'scalability', 'API integration']
                },
                impactMetrics: [
                    'increased revenue by X%',
                    'reduced costs by $X',
                    'improved efficiency by X%',
                    'grew user base by X%',
                    'decreased processing time by X%',
                    'achieved X% customer satisfaction',
                    'managed team of X people',
                    'handled $X budget'
                ]
            };

            // --- STATE MANAGEMENT ---
            let resumeData = {
                settings: {
                    template: 'template-modern',
                    color: '#0d6efd',
                    font: "'Inter', sans-serif"
                },
                personal: { name: 'FIRST LAST', title: 'Technical Program Manager', location: 'New York, NY', email: 'first.last@email.com', phone: '(123) 456-7890' },
                sections: [
                    {
                        id: 'experience', title: 'Professional Experience', type: 'experience', items: [
                            { id: Date.now() + 1, role: 'Technical Program Manager', company: 'Resume Worded', location: 'San Francisco, CA', duration: '2014-Present', description: 'Led multi-disciplinary 7 person team to design, develop, and launch online e-commerce store; prioritized and resolved 45+ new features and bug fixes.' },
                            { id: Date.now() + 2, role: 'Product Manager', company: 'GrowthSI', location: 'New York, NY', duration: '2012-2013', description: 'Spearheaded a cross-functional team (Technology, Business Development, Management) to implement new ERP system; successful adoption accelerated revenue growth by 25% in 1 year.' }
                        ]
                    },
                    {
                        id: 'education', title: 'Education', type: 'education', items: [
                            { id: Date.now() + 3, degree: 'Bachelor of Engineering, Major in Computer Science', institution: 'Resume Worded University', location: 'New York, NY', years: '2007-2011' }
                        ]
                    },
                    {
                        id: 'skills', title: 'Skills', type: 'custom', items: [
                            { id: Date.now() + 4, content: '<b>Programming Languages:</b> JavaScript, Python, SQL, HTML/CSS' },
                            { id: Date.now() + 5, content: '<b>Frameworks & Libraries:</b> React, Node.js, Express, Tailwind CSS' },
                            { id: Date.now() + 6, content: '<b>Tools & Platforms:</b> Git, Docker, Jira, Amazon Web Services (AWS)' }
                        ]
                    },
                    {
                        id: 'projects', title: 'Projects', type: 'custom', items: [
                            { id: Date.now() + 7, content: '<b>AI Resume Builder:</b> Developed a dynamic, client-side resume builder using HTML, CSS, and JavaScript, featuring multiple templates, live preview, and AI-powered analysis via the Gemini API.' }
                        ]
                    }
                ]
            };

            const formContainer = document.getElementById('form-container');
            const preview = document.getElementById('resume-preview');
            const toolbar = document.getElementById('toolbar');
            const aiModal = document.getElementById('ai-modal');
            const aiFeedbackEl = document.getElementById('ai-feedback');

            // Check if all elements exist
            if (!formContainer || !preview) {
                console.error('Critical elements not found:', { formContainer, preview });
                return;
            }

            console.log('All elements found, proceeding with initialization...');

            // --- RENDER FUNCTIONS ---
            function renderAll() {
                try {
                    console.log('Rendering all components...');
                    renderForm();
                    renderPreview();
                    applySettings();
                    console.log('Render complete');
                } catch (error) {
                    console.error('Error in renderAll:', error);
                }
            }

            function applySettings() {
                document.documentElement.style.setProperty('--accent-color', resumeData.settings.color);
                document.documentElement.style.setProperty('--body-font', resumeData.settings.font);
                preview.className = resumeData.settings.template;
            }

            function renderForm() {
                try {
                    console.log('Rendering form...');
                    formContainer.innerHTML = '';

                    // Design Settings Card
                    const settingsCard = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                            </svg>
                            Design Settings
                        </h3>
                        <p class="card-subtitle">Customize your resume appearance</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Template</label>
                            <div class="template-selector">
                                <div class="template-option ${resumeData.settings.template === 'template-modern' ? 'selected' : ''}" data-template="template-modern">
                                    <div class="template-preview">
                                        <div style="height: 20px; background: #6366f1; margin-bottom: 4px;"></div>
                                        <div style="height: 8px; background: #e5e7eb; margin-bottom: 2px;"></div>
                                        <div style="height: 8px; background: #e5e7eb; width: 80%;"></div>
                                    </div>
                                    <div class="text-xs font-medium">Modern</div>
                                </div>
                                <div class="template-option ${resumeData.settings.template === 'template-classic' ? 'selected' : ''}" data-template="template-classic">
                                    <div class="template-preview">
                                        <div style="display: flex; gap: 4px;">
                                            <div style="width: 30%; height: 76px; background: #f3f4f6;"></div>
                                            <div style="width: 70%;">
                                                <div style="height: 16px; background: #6366f1; margin-bottom: 4px;"></div>
                                                <div style="height: 6px; background: #e5e7eb; margin-bottom: 2px;"></div>
                                                <div style="height: 6px; background: #e5e7eb; width: 90%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs font-medium">Classic</div>
                                </div>
                                <div class="template-option ${resumeData.settings.template === 'template-creative' ? 'selected' : ''}" data-template="template-creative">
                                    <div class="template-preview">
                                        <div style="height: 16px; background: linear-gradient(45deg, #6366f1, #8b5cf6); margin-bottom: 4px; border-radius: 2px;"></div>
                                        <div style="height: 8px; background: #e5e7eb; margin-bottom: 2px;"></div>
                                        <div style="height: 8px; background: #e5e7eb; width: 75%;"></div>
                                    </div>
                                    <div class="text-xs font-medium">Creative</div>
                                </div>
                                <div class="template-option ${resumeData.settings.template === 'template-minimal' ? 'selected' : ''}" data-template="template-minimal">
                                    <div class="template-preview">
                                        <div style="height: 12px; background: #374151; margin-bottom: 8px;"></div>
                                        <div style="height: 6px; background: #e5e7eb; margin-bottom: 3px;"></div>
                                        <div style="height: 6px; background: #e5e7eb; width: 85%;"></div>
                                    </div>
                                    <div class="text-xs font-medium">Minimal</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                            <input type="color" data-path="settings.color" class="form-input h-12" value="${resumeData.settings.color}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Font Family</label>
                            <select data-path="settings.font" class="form-input">
                                <option value="'Inter', sans-serif" ${resumeData.settings.font.includes('Inter') ? 'selected' : ''}>Inter</option>
                                <option value="'Lora', serif" ${resumeData.settings.font.includes('Lora') ? 'selected' : ''}>Lora</option>
                                <option value="'Roboto', sans-serif" ${resumeData.settings.font.includes('Roboto') ? 'selected' : ''}>Roboto</option>
                            </select>
                        </div>
                    </div>
                </div>`;
                    formContainer.insertAdjacentHTML('beforeend', settingsCard);

                    // Personal Info Card
                    const personalCard = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Personal Information
                        </h3>
                        <p class="card-subtitle">Your basic contact details</p>
                    </div>
                    <div class="card-content space-y-4">
                        <input type="text" data-path="personal.name" class="form-input" value="${resumeData.personal.name}" placeholder="Full Name">
                        <input type="text" data-path="personal.title" class="form-input" value="${resumeData.personal.title}" placeholder="Job Title">
                        <input type="text" data-path="personal.location" class="form-input" value="${resumeData.personal.location}" placeholder="Location">
                        <input type="email" data-path="personal.email" class="form-input" value="${resumeData.personal.email}" placeholder="Email Address">
                        <input type="tel" data-path="personal.phone" class="form-input" value="${resumeData.personal.phone}" placeholder="Phone Number">
                    </div>
                </div>`;
                    formContainer.insertAdjacentHTML('beforeend', personalCard);

                    // Dynamic Sections Cards
                    resumeData.sections.forEach((section, secIndex) => {
                        const sectionCard = document.createElement('div');
                        sectionCard.className = 'card section-card';

                        const getSectionIcon = (type) => {
                            switch (type) {
                                case 'experience': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2H6a2 2 0 00-2 2v2m16 0H4m16 0v1.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 01-.293.707V17a2 2 0 01-2 2H9a2 2 0 01-2-2v-1.586a1 1 0 01-.293-.707L.293 8.707A1 1 0 010 8V6a2 2 0 012-2h2"></path>';
                                case 'education': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>';
                                default: return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>';
                            }
                        };

                        let itemsHTML = section.items.map((item, itemIndex) => {
                            let fields = '';
                            if (section.type === 'experience') {
                                fields = `<div class="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.role" class="form-input" value="${item.role || ''}" placeholder="Job Title">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.company" class="form-input" value="${item.company || ''}" placeholder="Company">
                                      </div>
                                      <div class="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.location" class="form-input" value="${item.location || ''}" placeholder="Location">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.duration" class="form-input" value="${item.duration || ''}" placeholder="Duration">
                                      </div>
                                      <textarea data-path="sections.${secIndex}.items.${itemIndex}.description" class="form-input h-20 resize-none" placeholder="Job description and achievements...">${(item.description || '').replace(/<br\s*\/?>/gi, '\n')}</textarea>`;
                            } else if (section.type === 'education') {
                                fields = `<div class="grid grid-cols-1 gap-3 mb-3">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.institution" class="form-input" value="${item.institution || ''}" placeholder="Institution">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.degree" class="form-input" value="${item.degree || ''}" placeholder="Degree">
                                      </div>
                                      <div class="grid grid-cols-2 gap-3">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.location" class="form-input" value="${item.location || ''}" placeholder="Location">
                                        <input type="text" data-path="sections.${secIndex}.items.${itemIndex}.years" class="form-input" value="${item.years || ''}" placeholder="Years">
                                      </div>`;
                            } else {
                                fields = `<textarea data-path="sections.${secIndex}.items.${itemIndex}.content" class="form-input h-20 resize-none" placeholder="Add details...">${(item.content || '').replace(/<br\s*\/?>/gi, '\n')}</textarea>`;
                            }
                            return `<div class="section-item">
                                    ${fields}
                                    <button data-sec-index="${secIndex}" data-item-index="${itemIndex}" class="remove-btn"></button>
                               </div>`;
                        }).join('');

                        sectionCard.innerHTML = `
                        <div class="card-header">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        ${getSectionIcon(section.type)}
                                    </svg>
                                    <input type="text" data-path="sections.${secIndex}.title" class="text-lg font-semibold bg-transparent border-none outline-none" value="${section.title}">
                                </div>
                                <button data-sec-index="${secIndex}" class="add-item-btn btn btn-secondary text-sm px-3 py-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            ${itemsHTML}
                        </div>`;
                        formContainer.appendChild(sectionCard);
                    });

                    // AI Tools Card
                    const aiCard = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            AI Assistant
                        </h3>
                        <p class="card-subtitle">Get intelligent feedback on your resume</p>
                    </div>
                    <div class="card-content">
                        <button id="ai-analyze-btn" class="btn btn-primary w-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Analyze Resume
                        </button>
                    </div>
                </div>`;
                    formContainer.insertAdjacentHTML('beforeend', aiCard);
                    console.log('Form rendered successfully');
                } catch (error) {
                    console.error('Error in renderForm:', error);
                }
            }

            function renderPreview() {
                try {
                    console.log('Rendering preview...');
                    preview.innerHTML = '';
                    // Header
                    const header = `<header class="text-center mb-8">
                    <h1 contenteditable="true" data-path="personal.name" class="font-serif text-4xl">${resumeData.personal.name}</h1>
                    <p contenteditable="true" data-path="personal.title" class="text-lg font-semibold my-2 accent-text">${resumeData.personal.title}</p>
                    <p class="text-sm text-gray-600">
                        <span contenteditable="true" data-path="personal.location">${resumeData.personal.location}</span> &bull;
                        <span contenteditable="true" data-path="personal.email">${resumeData.personal.email}</span> &bull;
                        <span contenteditable="true" data-path="personal.phone">${resumeData.personal.phone}</span>
                    </p>
                </header>`;
                    preview.insertAdjacentHTML('beforeend', header);

                    const sectionsContainer = document.createElement('div');
                    if (resumeData.settings.template === 'template-classic') {
                        sectionsContainer.innerHTML = `<div class="classic-sidebar space-y-6"></div><div class="classic-main space-y-6"></div>`;
                    }

                    resumeData.sections.forEach((section, secIndex) => {
                        let itemsHTML = section.items.map((item, itemIndex) => {
                            if (section.type === 'experience') {
                                return `<div class="mb-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.company" class="company-name">${item.company}</p>
                                            <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.role" class="job-title">${item.role}</p>
                                        </div>
                                        <div class="text-right text-sm text-gray-500 whitespace-nowrap pl-4">
                                            <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.location">${item.location}</p>
                                            <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.duration">${item.duration}</p>
                                        </div>
                                    </div>
                                    <div contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.description" class="mt-1 text-sm text-gray-700">${item.description}</div>
                                </div>`;
                            }
                            if (section.type === 'education') {
                                return `<div class="flex justify-between items-start mb-2">
                                    <div>
                                       <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.institution" class="company-name">${item.institution}</p>
                                       <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.degree" class="text-sm">${item.degree}</p>
                                    </div>
                                    <div class="text-right text-sm text-gray-500 whitespace-nowrap pl-4">
                                        <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.location">${item.location}</p>
                                        <p contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.years">${item.years}</p>
                                    </div>
                                </div>`;
                            }
                            // custom
                            return `<div contenteditable="true" data-path="sections.${secIndex}.items.${itemIndex}.content" class="text-sm text-gray-700 mb-2">${item.content}</div>`;
                        }).join('');

                        const sectionElHTML = `<section class="resume-section mb-6" data-id="${section.id}">
                    <h2 contenteditable="true" data-path="sections.${secIndex}.title" class="section-title pb-1 mb-4">${section.title}</h2>
                    <div class="space-y-3">${itemsHTML}</div>
                </section>`;

                        if (resumeData.settings.template === 'template-classic' && (section.type === 'education' || section.type === 'skills')) {
                            sectionsContainer.querySelector('.classic-sidebar').insertAdjacentHTML('beforeend', sectionElHTML);
                        } else if (resumeData.settings.template === 'template-classic') {
                            sectionsContainer.querySelector('.classic-main').insertAdjacentHTML('beforeend', sectionElHTML);
                        } else {
                            preview.insertAdjacentHTML('beforeend', sectionElHTML);
                        }
                    });

                    if (resumeData.settings.template === 'template-classic') {
                        preview.appendChild(sectionsContainer);
                    }
                    console.log('Preview rendered successfully');
                } catch (error) {
                    console.error('Error in renderPreview:', error);
                }
            }

            // --- EVENT HANDLERS ---
            function handleInput(e) {
                const path = e.target.dataset.path;
                if (!path) return;
                const value = e.target.isContentEditable ? e.target.innerHTML : e.target.value;
                setNestedValue(resumeData, path, value);

                if (path.startsWith('settings')) {
                    applySettings();
                    renderPreview(); // Rerender preview for template changes
                    return;
                }

                // Update corresponding elements without full rerender
                updateCorrespondingElement(path, value, e.target);
            }

            function updateCorrespondingElement(path, value, sourceElement) {
                // Find all elements with the same data-path
                const allElements = document.querySelectorAll(`[data-path="${path}"]`);

                allElements.forEach(element => {
                    if (element === sourceElement) return; // Skip the source element

                    if (element.isContentEditable) {
                        element.innerHTML = value;
                    } else {
                        element.value = value;
                    }
                });
            }

            formContainer.addEventListener('input', handleInput);
            preview.addEventListener('input', handleInput);

            document.getElementById('add-section-btn').addEventListener('click', () => {
                const title = prompt("Enter title for new section:", "Projects");
                if (title) {
                    resumeData.sections.push({ id: Date.now(), title: title, type: 'custom', items: [{ id: Date.now() + 1, content: 'Details about your project...' }] });
                    // Use setTimeout to avoid interrupting any ongoing edits
                    setTimeout(() => renderAll(), 50);
                }
            });

            // Event delegation for remove/add item buttons
            formContainer.addEventListener('click', e => {
                if (e.target.classList.contains('remove-btn') || e.target.closest('.remove-btn')) {
                    const btn = e.target.classList.contains('remove-btn') ? e.target : e.target.closest('.remove-btn');
                    const { secIndex, itemIndex } = btn.dataset;
                    resumeData.sections[secIndex].items.splice(itemIndex, 1);
                    setTimeout(() => renderAll(), 50);
                }
                if (e.target.classList.contains('add-item-btn') || e.target.closest('.add-item-btn')) {
                    const btn = e.target.classList.contains('add-item-btn') ? e.target : e.target.closest('.add-item-btn');
                    const secIndex = btn.dataset.secIndex;
                    const section = resumeData.sections[secIndex];
                    let newItem = { id: Date.now() };
                    if (section.type === 'experience') newItem = { ...newItem, role: '', company: '', location: '', duration: '', description: '' };
                    else if (section.type === 'education') newItem = { ...newItem, institution: '', degree: '', location: '', years: '' };
                    else newItem = { ...newItem, content: '' };
                    section.items.push(newItem);
                    setTimeout(() => renderAll(), 50);
                }
            });

            // Enhanced Text Toolbar with AI Rewrite
            document.addEventListener('mouseup', e => {
                const selection = window.getSelection();
                if (selection.toString().length > 0 && e.target.closest('[contenteditable="true"]')) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    toolbar.style.left = `${rect.left + window.scrollX + rect.width / 2 - toolbar.offsetWidth / 2}px`;
                    toolbar.style.top = `${rect.top + window.scrollY - toolbar.offsetHeight - 5}px`;
                    toolbar.style.display = 'flex';

                    // Add AI rewrite button if not exists
                    if (!toolbar.querySelector('#ai-rewrite-btn')) {
                        const aiBtn = document.createElement('button');
                        aiBtn.id = 'ai-rewrite-btn';
                        aiBtn.title = 'AI Rewrite';
                        aiBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>`;
                        aiBtn.addEventListener('click', rewriteSelectedText);
                        toolbar.appendChild(aiBtn);
                    }
                } else {
                    setTimeout(() => toolbar.style.display = 'none', 100);
                }
            });

            document.getElementById('bold-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.execCommand('bold');
                // Update data after formatting
                const activeElement = document.activeElement;
                if (activeElement && activeElement.dataset.path) {
                    setNestedValue(resumeData, activeElement.dataset.path, activeElement.innerHTML);
                    updateCorrespondingElement(activeElement.dataset.path, activeElement.innerHTML, activeElement);
                }
            });

            document.getElementById('italic-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.execCommand('italic');
                // Update data after formatting
                const activeElement = document.activeElement;
                if (activeElement && activeElement.dataset.path) {
                    setNestedValue(resumeData, activeElement.dataset.path, activeElement.innerHTML);
                    updateCorrespondingElement(activeElement.dataset.path, activeElement.innerHTML, activeElement);
                }
            });

            document.getElementById('underline-btn').addEventListener('click', (e) => {
                e.preventDefault();
                document.execCommand('underline');
                // Update data after formatting
                const activeElement = document.activeElement;
                if (activeElement && activeElement.dataset.path) {
                    setNestedValue(resumeData, activeElement.dataset.path, activeElement.innerHTML);
                    updateCorrespondingElement(activeElement.dataset.path, activeElement.innerHTML, activeElement);
                }
            });

            document.getElementById('link-btn').addEventListener('click', (e) => {
                e.preventDefault();
                const url = prompt('Enter the URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                    // Update data after formatting
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.dataset.path) {
                        setNestedValue(resumeData, activeElement.dataset.path, activeElement.innerHTML);
                        updateCorrespondingElement(activeElement.dataset.path, activeElement.innerHTML, activeElement);
                    }
                }
            });

            // AI Analysis event listener moved to enhanced version below

            // Close AI modal event listener
            document.getElementById('close-ai-modal').addEventListener('click', () => aiModal.classList.add('hidden'));

            // PDF Download functionality
            document.getElementById('download-pdf-btn').addEventListener('click', async () => {
                const resumeContainer = document.getElementById('resume-container');
                const downloadBtn = document.getElementById('download-pdf-btn');

                // Show loading state
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Generating PDF...';
                downloadBtn.disabled = true;

                try {
                    const canvas = await html2canvas(resumeContainer, {
                        scale: 1.5,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: resumeContainer.scrollWidth,
                        height: resumeContainer.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    const pageWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // If content is longer than one page, split it
                    if (imgHeight > pageHeight) {
                        let yPosition = 0;
                        const pageCount = Math.ceil(imgHeight / pageHeight);

                        for (let i = 0; i < pageCount; i++) {
                            if (i > 0) {
                                pdf.addPage();
                            }

                            const sourceY = (canvas.height / pageCount) * i;
                            const sourceHeight = Math.min(canvas.height / pageCount, canvas.height - sourceY);

                            // Create a temporary canvas for this page section
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCanvas.width = canvas.width;
                            tempCanvas.height = sourceHeight;

                            tempCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);

                            pdf.addImage(tempCanvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, pageHeight);
                        }
                    } else {
                        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                    }

                    pdf.save(`${resumeData.personal.name.replace(/\s+/g, '_')}_Resume.pdf`);
                } catch (error) {
                    console.error('PDF generation failed:', error);
                    alert('Failed to generate PDF. Please try again.');
                } finally {
                    // Restore button state
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }
            });

            // Utility to set nested values in the data object
            function setNestedValue(obj, path, value) {
                const keys = path.split(/[\.\[\]]/).filter(Boolean);
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
            }

            // --- NEW FEATURES IMPLEMENTATION ---

            // Template Selection
            document.addEventListener('click', (e) => {
                if (e.target.closest('.template-option')) {
                    const templateOption = e.target.closest('.template-option');
                    const template = templateOption.dataset.template;

                    // Update selection
                    document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
                    templateOption.classList.add('selected');

                    // Update data and render
                    resumeData.settings.template = template;
                    applySettings();
                    renderPreview();
                }
            });

            // Drag and Drop for Sections
            let sortable;
            function initializeDragDrop() {
                const container = document.getElementById('form-container');
                if (sortable && sortable.destroy) sortable.destroy();

                if (typeof Sortable !== 'undefined') {
                    sortable = new Sortable(container, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        filter: '.card:not(.section-card)',
                        onEnd: function (evt) {
                            const oldIndex = evt.oldIndex;
                            const newIndex = evt.newIndex;

                            // Skip non-section cards (design, personal, import, ai cards)
                            const sectionStartIndex = 4; // After design, personal, import, and ai cards
                            if (oldIndex < sectionStartIndex || newIndex < sectionStartIndex) return;

                            const sectionOldIndex = oldIndex - sectionStartIndex;
                            const sectionNewIndex = newIndex - sectionStartIndex;

                            if (sectionOldIndex >= 0 && sectionNewIndex >= 0 &&
                                sectionOldIndex < resumeData.sections.length &&
                                sectionNewIndex < resumeData.sections.length) {
                                // Reorder sections in data
                                const movedSection = resumeData.sections.splice(sectionOldIndex, 1)[0];
                                resumeData.sections.splice(sectionNewIndex, 0, movedSection);

                                renderAll();
                            }
                        }
                    });
                }
            }

            // Import/Export Functionality
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    if (file.name.endsWith('.json')) {
                        const text = await file.text();
                        const importedData = JSON.parse(text);
                        resumeData = { ...resumeData, ...importedData };
                        renderAll();
                        showNotification('Resume imported successfully!', 'success');
                    } else if (file.name.endsWith('.docx')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        // Simple parsing - you can enhance this
                        const lines = result.value.split('\n').filter(line => line.trim());
                        if (lines.length > 0) {
                            resumeData.personal.name = lines[0] || 'Imported Name';
                            showNotification('DOCX content extracted! Please review and organize.', 'warning');
                        }
                        renderAll();
                    }
                } catch (error) {
                    showNotification('Error importing file: ' + error.message, 'error');
                }
                e.target.value = '';
            });

            document.getElementById('save-btn').addEventListener('click', () => {
                try {
                    const dataStr = JSON.stringify(resumeData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });

                    if (typeof saveAs !== 'undefined') {
                        saveAs(dataBlob, `${resumeData.personal.name.replace(/\s+/g, '_')}_resume.json`);
                    } else {
                        // Fallback download method
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${resumeData.personal.name.replace(/\s+/g, '_')}_resume.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                    showNotification('Resume saved successfully!', 'success');
                } catch (error) {
                    showNotification('Error saving resume: ' + error.message, 'error');
                }
            });

            // Download PDF button already handled by the main PDF download function

            document.getElementById('download-docx-btn').addEventListener('click', () => {
                // Simple DOCX export (you can enhance with proper DOCX library)
                const content = document.getElementById('resume-preview').innerText;
                const blob = new Blob([content], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                saveAs(blob, `${resumeData.personal.name.replace(/\s+/g, '_')}_resume.docx`);
                showNotification('DOCX exported successfully!', 'success');
            });

            document.getElementById('download-json-btn').addEventListener('click', () => {
                document.getElementById('save-btn').click(); // Use save function
            });

            // Preview Mode Controls
            let currentZoom = 100;

            document.getElementById('preview-desktop').addEventListener('click', () => {
                setPreviewMode('desktop');
            });

            document.getElementById('preview-mobile').addEventListener('click', () => {
                setPreviewMode('mobile');
            });

            document.getElementById('preview-print').addEventListener('click', () => {
                setPreviewMode('print');
            });

            function setPreviewMode(mode) {
                const container = document.getElementById('resume-container');
                const wrapper = document.getElementById('preview-wrapper');

                // Update active button
                document.querySelectorAll('[id^="preview-"]').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`preview-${mode}`).classList.add('active');

                switch (mode) {
                    case 'mobile':
                        container.style.width = '375px';
                        container.style.maxWidth = '375px';
                        break;
                    case 'print':
                        container.style.width = '210mm';
                        container.style.maxWidth = '210mm';
                        wrapper.style.transform = 'scale(0.8)';
                        break;
                    default: // desktop
                        container.style.width = '210mm';
                        container.style.maxWidth = '100%';
                        wrapper.style.transform = 'scale(1)';
                }
            }

            // Zoom Controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 10, 200);
                updateZoom();
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 10, 50);
                updateZoom();
            });

            function updateZoom() {
                const wrapper = document.getElementById('preview-wrapper');
                wrapper.style.transform = `scale(${currentZoom / 100})`;
                document.getElementById('zoom-level').textContent = `${currentZoom}%`;
            }

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'e':
                            e.preventDefault();
                            document.getElementById('download-pdf-btn').click();
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('add-section-btn').click();
                            break;
                        case 's':
                            e.preventDefault();
                            document.getElementById('save-btn').click();
                            break;
                        case 'b':
                            if (document.activeElement && document.activeElement.isContentEditable) {
                                e.preventDefault();
                                document.getElementById('bold-btn').click();
                            }
                            break;
                        case 'i':
                            if (document.activeElement && document.activeElement.isContentEditable) {
                                e.preventDefault();
                                document.getElementById('italic-btn').click();
                            }
                            break;
                    }
                }
            });

            // Auto-save functionality
            let autoSaveTimeout;
            function scheduleAutoSave() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    localStorage.setItem('resumeBuilder_autoSave', JSON.stringify(resumeData));
                    showNotification('Auto-saved', 'info', 1000);
                }, 3000);
            }



            // === ADVANCED AI ANALYZER === //

            // Comprehensive Industry & Company Database
            const industryDatabase = {
                'technology': {
                    companies: ['Google', 'Microsoft', 'Apple', 'Amazon', 'Meta', 'Netflix', 'Tesla', 'Uber', 'Airbnb', 'Spotify'],
                    keywords: ['agile', 'scrum', 'api', 'cloud', 'microservices', 'devops', 'ci/cd', 'kubernetes', 'docker', 'aws'],
                    skills: ['JavaScript', 'Python', 'React', 'Node.js', 'AWS', 'Docker', 'Kubernetes', 'Git', 'SQL', 'NoSQL'],
                    actionVerbs: ['Architected', 'Engineered', 'Optimized', 'Scaled', 'Deployed', 'Automated', 'Integrated'],
                    atsKeywords: ['software development', 'full stack', 'backend', 'frontend', 'database', 'api development']
                },
                'finance': {
                    companies: ['Goldman Sachs', 'JPMorgan', 'Morgan Stanley', 'BlackRock', 'Visa', 'Mastercard', 'PayPal'],
                    keywords: ['risk management', 'portfolio', 'derivatives', 'compliance', 'regulatory', 'fintech', 'blockchain'],
                    skills: ['Excel', 'SQL', 'Python', 'R', 'Bloomberg', 'Risk Management', 'Financial Modeling', 'Tableau'],
                    actionVerbs: ['Analyzed', 'Forecasted', 'Managed', 'Optimized', 'Assessed', 'Mitigated', 'Structured'],
                    atsKeywords: ['financial analysis', 'risk assessment', 'portfolio management', 'investment', 'trading']
                },
                'healthcare': {
                    companies: ['Johnson & Johnson', 'Pfizer', 'UnitedHealth', 'Moderna', 'Abbott', 'Medtronic'],
                    keywords: ['clinical', 'regulatory', 'fda', 'gcp', 'hipaa', 'ehr', 'telemedicine', 'patient care'],
                    skills: ['Clinical Research', 'Regulatory Affairs', 'Data Analysis', 'Medical Writing', 'HIPAA', 'EMR'],
                    actionVerbs: ['Diagnosed', 'Treated', 'Researched', 'Analyzed', 'Coordinated', 'Implemented'],
                    atsKeywords: ['patient care', 'clinical experience', 'medical research', 'healthcare', 'treatment']
                },
                'marketing': {
                    companies: ['Procter & Gamble', 'Unilever', 'Coca-Cola', 'Nike', 'Adobe', 'Salesforce'],
                    keywords: ['seo', 'sem', 'social media', 'content marketing', 'brand management', 'analytics', 'roi'],
                    skills: ['Google Analytics', 'SEO', 'SEM', 'Social Media', 'Content Strategy', 'Adobe Creative Suite'],
                    actionVerbs: ['Launched', 'Promoted', 'Increased', 'Generated', 'Optimized', 'Targeted', 'Converted'],
                    atsKeywords: ['digital marketing', 'brand management', 'campaign management', 'social media marketing']
                },
                'consulting': {
                    companies: ['McKinsey', 'BCG', 'Bain', 'Deloitte', 'PwC', 'EY', 'KPMG', 'Accenture'],
                    keywords: ['strategy', 'transformation', 'process improvement', 'stakeholder management', 'change management'],
                    skills: ['Strategic Planning', 'Process Improvement', 'Data Analysis', 'Project Management', 'Stakeholder Management'],
                    actionVerbs: ['Advised', 'Transformed', 'Streamlined', 'Facilitated', 'Recommended', 'Delivered'],
                    atsKeywords: ['management consulting', 'strategy consulting', 'business transformation', 'process optimization']
                }
            };

            // Advanced Grammar & Writing Analysis
            const grammarRules = {
                commonErrors: [
                    { pattern: /\bi\b/g, suggestion: 'Use "I" (capital) instead of "i"' },
                    { pattern: /\bteh\b/g, suggestion: 'Use "the" instead of "teh"' },
                    { pattern: /\brecieve\b/g, suggestion: 'Use "receive" instead of "recieve"' },
                    { pattern: /\baccommodate\b/g, suggestion: 'Check spelling: "accommodate"' },
                    { pattern: /\bseperate\b/g, suggestion: 'Use "separate" instead of "seperate"' },
                    { pattern: /\bdefinately\b/g, suggestion: 'Use "definitely" instead of "definately"' }
                ],
                weakWords: ['very', 'really', 'quite', 'rather', 'pretty', 'somewhat', 'kind of', 'sort of'],
                strongActionVerbs: ['Spearheaded', 'Orchestrated', 'Pioneered', 'Revolutionized', 'Transformed', 'Accelerated', 'Amplified'],
                passiveIndicators: ['was', 'were', 'been', 'being', 'is', 'are', 'am'],
                redundantPhrases: ['in order to', 'due to the fact that', 'at this point in time', 'for the purpose of']
            };

            // ATS Optimization Database
            const atsOptimization = {
                problematicFormats: [
                    { pattern: /[]/g, issue: 'Special bullet characters may not parse correctly' },
                    { pattern: /[]/g, issue: 'Arrow symbols may cause parsing issues' },
                    { pattern: /[]/g, issue: 'Star ratings may not be recognized' },
                    { pattern: /\t/g, issue: 'Tab characters may cause formatting issues' }
                ],
                goodKeywords: ['experience', 'skills', 'education', 'achievements', 'results', 'managed', 'led', 'developed'],
                sectionHeaders: ['experience', 'education', 'skills', 'projects', 'certifications', 'achievements'],
                dateFormats: [/\d{4}-\d{4}/, /\d{1,2}\/\d{4}/, /\w+ \d{4}/]
            };

            // Enhanced AI Features (Client-side + Real AI)

            // --- SECURITY & SANITIZATION ---
            const SecurityUtils = {
                // Sanitize HTML input to prevent XSS
                sanitizeHTML: function (str) {
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                },

                // Validate and sanitize user input
                validateInput: function (input, maxLength = 1000) {
                    if (typeof input !== 'string') return '';

                    // Remove potentially dangerous characters
                    let sanitized = input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                    sanitized = sanitized.replace(/javascript:/gi, '');
                    sanitized = sanitized.replace(/on\w+\s*=/gi, '');

                    // Limit length
                    return sanitized.substring(0, maxLength);
                },

                // Rate limiting for API calls
                rateLimiter: {
                    calls: [],
                    maxCalls: 10,
                    timeWindow: 60000, // 1 minute

                    canMakeCall: function () {
                        const now = Date.now();
                        this.calls = this.calls.filter(time => now - time < this.timeWindow);
                        return this.calls.length < this.maxCalls;
                    },

                    recordCall: function () {
                        this.calls.push(Date.now());
                    }
                },

                // Validate API responses
                validateAPIResponse: function (response) {
                    if (!response || typeof response !== 'object') return false;

                    // Check for suspicious content
                    const responseStr = JSON.stringify(response).toLowerCase();
                    const suspiciousPatterns = ['<script', 'javascript:', 'eval(', 'function('];

                    return !suspiciousPatterns.some(pattern => responseStr.includes(pattern));
                }
            };

            // Hugging Face API for real AI assistance (Free tier) - with security
            const HUGGING_FACE_API = 'https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium';

            // Core AI functions - moved to top level for accessibility
            // getSmartSuggestions function moved to top level above

            async function rewriteSentenceWithAI(sentence, context = 'general') {
                // Security: Validate and sanitize input
                const sanitizedSentence = SecurityUtils.validateInput(sentence, 500);
                if (!sanitizedSentence || sanitizedSentence.length < 5) {
                    throw new Error('Invalid input sentence');
                }

                // Rate limiting
                if (!SecurityUtils.rateLimiter.canMakeCall()) {
                    throw new Error('Rate limit exceeded. Please wait before making more requests.');
                }

                try {
                    // Enhanced prompt based on context
                    const contextPrompts = {
                        'leadership': 'Rewrite this leadership experience to show impact and team management:',
                        'technical': 'Rewrite this technical achievement to highlight skills and results:',
                        'achievement': 'Rewrite this accomplishment to emphasize quantifiable impact:',
                        'general': 'Rewrite this resume bullet point to be more impactful and professional:'
                    };

                    const prompt = `${contextPrompts[context] || contextPrompts.general} "${sanitizedSentence}"`;

                    SecurityUtils.rateLimiter.recordCall();

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

                    const response = await fetch(HUGGING_FACE_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_length: 150,
                                temperature: 0.7,
                                do_sample: true,
                                top_p: 0.9
                            }
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const result = await response.json();

                        // Security: Validate API response
                        if (SecurityUtils.validateAPIResponse(result)) {
                            const aiText = result[0]?.generated_text || result.generated_text;
                            if (aiText && aiText.length > sanitizedSentence.length) {
                                return SecurityUtils.validateInput(aiText, 300);
                            }
                        }
                    }
                } catch (error) {
                    console.log('AI rewrite failed, using enhanced local improvement:', error);
                }

                // Enhanced fallback with context-aware improvements
                return improveWeakSentenceAdvanced(sanitizedSentence, context);
            }

            function improveWeakSentenceAdvanced(sentence, context = 'general') {
                const improvements = {
                    'responsible for': 'Managed',
                    'helped with': 'Contributed to',
                    'worked on': 'Developed',
                    'assisted': 'Supported',
                    'participated': 'Collaborated on',
                    'was involved': 'Led',
                    'did': 'Executed',
                    'made': 'Created',
                    'got': 'Achieved',
                    'used': 'Utilized',
                    'handled': 'Managed',
                    'dealt with': 'Resolved',
                    'took care of': 'Oversaw',
                    'was part of': 'Contributed to',
                    'helped to': 'Facilitated'
                };

                let improved = sentence;

                // Apply basic improvements
                for (const [weak, strong] of Object.entries(improvements)) {
                    improved = improved.replace(new RegExp(`\\b${weak}\\b`, 'gi'), strong);
                }

                // Context-specific enhancements
                const contextVerbs = aiSuggestions.actionVerbs[context] || aiSuggestions.actionVerbs.achievement;
                const randomVerb = contextVerbs[Math.floor(Math.random() * contextVerbs.length)];

                // Replace generic verbs with context-specific ones
                if (context === 'leadership' && !improved.match(/led|managed|directed|guided/i)) {
                    improved = improved.replace(/^(handled|did|worked)/i, randomVerb);
                }

                // Add quantification suggestions
                if (!improved.match(/\d+%|\$\d+|\d+\s*(years?|months?|weeks?|days?|people|team|users|customers)/)) {
                    const metricSuggestion = aiSuggestions.impactMetrics[Math.floor(Math.random() * aiSuggestions.impactMetrics.length)];
                    improved += ` [Suggestion: ${metricSuggestion}]`;
                }

                return improved;
            }

            // Keep backward compatibility
            function improveWeakSentence(sentence) {
                return improveWeakSentenceAdvanced(sentence, 'general');
            }

            function getSmartSuggestions(text, context) {
                const suggestions = [];
                const lowerText = text.toLowerCase();
                const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);

                // Action verb suggestions
                if (context === 'description' && !aiSuggestions.actionVerbs.some(verb => lowerText.includes(verb.toLowerCase()))) {
                    suggestions.push({
                        type: 'action-verb',
                        message: 'Consider starting with a strong action verb',
                        suggestions: aiSuggestions.actionVerbs.slice(0, 3)
                    });
                }

                // Sentence improvement suggestions
                sentences.forEach((sentence, index) => {
                    const trimmed = sentence.trim();
                    if (trimmed.length > 0) {
                        // Check for weak language
                        const weakWords = ['responsible for', 'helped with', 'worked on', 'assisted', 'participated', 'was involved', 'did'];
                        const hasWeakLanguage = weakWords.some(weak => trimmed.toLowerCase().includes(weak));

                        if (hasWeakLanguage) {
                            suggestions.push({
                                type: 'sentence-improvement',
                                message: `Sentence ${index + 1}: Replace weak language with strong action verbs`,
                                original: trimmed,
                                improved: improveWeakSentence(trimmed)
                            });
                        }

                        // Check for missing quantification
                        const hasNumbers = /\d/.test(trimmed);
                        if (!hasNumbers && trimmed.length > 20) {
                            suggestions.push({
                                type: 'quantification',
                                message: `Sentence ${index + 1}: Add specific numbers or metrics`,
                                original: trimmed,
                                suggestion: 'Add percentages, dollar amounts, timeframes, or quantities to make impact measurable'
                            });
                        }

                        // Check sentence length
                        if (trimmed.length > 150) {
                            suggestions.push({
                                type: 'length',
                                message: `Sentence ${index + 1}: Too long - consider breaking into shorter sentences`,
                                original: trimmed
                            });
                        }
                    }
                });

                // Skill suggestions based on job title
                const jobTitle = resumeData.personal.title.toLowerCase();
                for (const [role, skills] of Object.entries(aiSuggestions.skills)) {
                    if (jobTitle.includes(role)) {
                        const missingSkills = skills.filter(skill => !lowerText.includes(skill.toLowerCase()));
                        if (missingSkills.length > 0) {
                            suggestions.push({
                                type: 'skills',
                                message: `Consider adding these ${role} skills`,
                                suggestions: missingSkills.slice(0, 3)
                            });
                        }
                        break;
                    }
                }

                return suggestions;
            }

            // === ADVANCED ANALYSIS FUNCTIONS === //

            function detectIndustryAndCompany(resumeText) {
                const text = resumeText.toLowerCase();
                let detectedIndustry = 'general';
                let detectedCompanies = [];
                let industryScore = 0;

                // Detect industry based on keywords and skills
                for (const [industry, data] of Object.entries(industryDatabase)) {
                    let score = 0;

                    // Check for industry keywords
                    data.keywords.forEach(keyword => {
                        if (text.includes(keyword.toLowerCase())) score += 2;
                    });

                    // Check for industry skills
                    data.skills.forEach(skill => {
                        if (text.includes(skill.toLowerCase())) score += 3;
                    });

                    // Check for companies
                    data.companies.forEach(company => {
                        if (text.includes(company.toLowerCase())) {
                            score += 5;
                            detectedCompanies.push(company);
                        }
                    });

                    if (score > industryScore) {
                        industryScore = score;
                        detectedIndustry = industry;
                    }
                }

                return { industry: detectedIndustry, companies: detectedCompanies, confidence: industryScore };
            }

            function analyzeGrammarAndWriting(text) {
                const issues = [];
                let grammarScore = 100;

                // Check for common grammar errors
                grammarRules.commonErrors.forEach(rule => {
                    const matches = text.match(rule.pattern);
                    if (matches) {
                        issues.push({
                            type: 'grammar',
                            severity: 'high',
                            message: rule.suggestion,
                            count: matches.length
                        });
                        grammarScore -= matches.length * 5;
                    }
                });

                // Check for weak words
                const weakWordCount = grammarRules.weakWords.reduce((count, word) => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    const matches = text.match(regex);
                    return count + (matches ? matches.length : 0);
                }, 0);

                if (weakWordCount > 0) {
                    issues.push({
                        type: 'style',
                        severity: 'medium',
                        message: `Found ${weakWordCount} weak words. Consider using stronger alternatives.`,
                        suggestions: ['Replace with specific, quantifiable terms']
                    });
                    grammarScore -= weakWordCount * 2;
                }

                // Check for passive voice
                const sentences = text.split(/[.!?]+/);
                let passiveCount = 0;
                sentences.forEach(sentence => {
                    const hasPassive = grammarRules.passiveIndicators.some(indicator =>
                        sentence.toLowerCase().includes(` ${indicator} `)
                    );
                    if (hasPassive) passiveCount++;
                });

                if (passiveCount > sentences.length * 0.3) {
                    issues.push({
                        type: 'style',
                        severity: 'medium',
                        message: 'Too much passive voice. Use active voice for stronger impact.',
                        suggestions: ['Start sentences with action verbs', 'Focus on what YOU did']
                    });
                    grammarScore -= 10;
                }

                return { score: Math.max(0, grammarScore), issues };
            }

            function calculateAdvancedATSScore(resumeText, industry) {
                let atsScore = 100;
                const issues = [];
                const industryData = industryDatabase[industry] || industryDatabase['technology'];

                // Check for problematic formatting
                atsOptimization.problematicFormats.forEach(format => {
                    const matches = resumeText.match(format.pattern);
                    if (matches) {
                        issues.push({
                            type: 'formatting',
                            severity: 'high',
                            message: format.issue,
                            count: matches.length
                        });
                        atsScore -= matches.length * 3;
                    }
                });

                // Check for industry-specific keywords
                const industryKeywordCount = industryData.atsKeywords.reduce((count, keyword) => {
                    return count + (resumeText.toLowerCase().includes(keyword) ? 1 : 0);
                }, 0);

                const keywordDensity = industryKeywordCount / industryData.atsKeywords.length;
                if (keywordDensity < 0.3) {
                    issues.push({
                        type: 'keywords',
                        severity: 'high',
                        message: `Low industry keyword density (${Math.round(keywordDensity * 100)}%). Add more relevant keywords.`,
                        suggestions: industryData.atsKeywords.slice(0, 3)
                    });
                    atsScore -= 20;
                }

                // Check for proper section headers
                const hasProperSections = atsOptimization.sectionHeaders.some(header =>
                    resumeText.toLowerCase().includes(header)
                );

                if (!hasProperSections) {
                    issues.push({
                        type: 'structure',
                        severity: 'medium',
                        message: 'Missing standard section headers that ATS systems expect.',
                        suggestions: ['Add clear section headers like "Experience", "Education", "Skills"']
                    });
                    atsScore -= 15;
                }

                // Check for contact information
                const hasEmail = /@/.test(resumeText);
                const hasPhone = /\(\d{3}\)|\d{3}-\d{3}-\d{4}|\d{10}/.test(resumeText);

                if (!hasEmail || !hasPhone) {
                    issues.push({
                        type: 'contact',
                        severity: 'high',
                        message: 'Missing essential contact information.',
                        suggestions: ['Ensure email and phone number are clearly visible']
                    });
                    atsScore -= 10;
                }

                return { score: Math.max(0, atsScore), issues };
            }

            function getIndustrySpecificSuggestions(industry, resumeText) {
                const suggestions = [];
                const industryData = industryDatabase[industry] || industryDatabase['technology'];
                const text = resumeText.toLowerCase();

                // Missing skills analysis
                const missingSkills = industryData.skills.filter(skill =>
                    !text.includes(skill.toLowerCase())
                ).slice(0, 5);

                if (missingSkills.length > 0) {
                    suggestions.push({
                        type: 'skills',
                        priority: 'high',
                        title: `${industry.charAt(0).toUpperCase() + industry.slice(1)} Skills Gap`,
                        message: `Consider adding these in-demand ${industry} skills:`,
                        items: missingSkills
                    });
                }

                // Action verb optimization
                const hasStrongVerbs = industryData.actionVerbs.some(verb =>
                    text.includes(verb.toLowerCase())
                );

                if (!hasStrongVerbs) {
                    suggestions.push({
                        type: 'impact',
                        priority: 'medium',
                        title: 'Strengthen Your Impact',
                        message: `Use ${industry}-specific action verbs:`,
                        items: industryData.actionVerbs.slice(0, 4)
                    });
                }

                // Company alignment
                const hasRelevantCompanies = industryData.companies.some(company =>
                    text.includes(company.toLowerCase())
                );

                if (!hasRelevantCompanies) {
                    suggestions.push({
                        type: 'targeting',
                        priority: 'low',
                        title: 'Industry Targeting',
                        message: `Consider highlighting experience with ${industry} leaders:`,
                        items: industryData.companies.slice(0, 3)
                    });
                }

                return suggestions;
            }

            function calculateCompetitiveScore(resumeText, industry) {
                const industryData = industryDatabase[industry] || industryDatabase['technology'];
                let competitiveScore = 0;
                const factors = [];

                // Quantified achievements
                const numberMatches = resumeText.match(/\d+%|\$\d+|\d+\+|\d+ years?|\d+ months?/g);
                const quantificationScore = Math.min(30, (numberMatches?.length || 0) * 5);
                competitiveScore += quantificationScore;
                factors.push({
                    factor: 'Quantified Achievements',
                    score: quantificationScore,
                    max: 30,
                    feedback: numberMatches?.length > 3 ? 'Excellent use of numbers' : 'Add more quantified results'
                });

                // Industry expertise
                const expertiseScore = Math.min(25, industryData.skills.reduce((score, skill) => {
                    return score + (resumeText.toLowerCase().includes(skill.toLowerCase()) ? 3 : 0);
                }, 0));
                competitiveScore += expertiseScore;
                factors.push({
                    factor: 'Industry Expertise',
                    score: expertiseScore,
                    max: 25,
                    feedback: expertiseScore > 15 ? 'Strong technical skills' : 'Expand technical skill set'
                });

                // Leadership indicators
                const leadershipWords = ['led', 'managed', 'directed', 'supervised', 'coordinated', 'mentored'];
                const leadershipScore = Math.min(20, leadershipWords.reduce((score, word) => {
                    return score + (resumeText.toLowerCase().includes(word) ? 3 : 0);
                }, 0));
                competitiveScore += leadershipScore;
                factors.push({
                    factor: 'Leadership Experience',
                    score: leadershipScore,
                    max: 20,
                    feedback: leadershipScore > 10 ? 'Good leadership indicators' : 'Highlight leadership roles'
                });

                // Innovation & impact
                const innovationWords = ['created', 'developed', 'designed', 'built', 'launched', 'implemented'];
                const innovationScore = Math.min(25, innovationWords.reduce((score, word) => {
                    return score + (resumeText.toLowerCase().includes(word) ? 3 : 0);
                }, 0));
                competitiveScore += innovationScore;
                factors.push({
                    factor: 'Innovation & Impact',
                    score: innovationScore,
                    max: 25,
                    feedback: innovationScore > 15 ? 'Strong innovation focus' : 'Emphasize creative contributions'
                });

                return { score: competitiveScore, factors, maxScore: 100 };
            }

            // Experience Level Detection
            function determineExperienceLevel(text) {
                const textLower = text.toLowerCase();

                // Years of experience indicators
                const yearMatches = text.match(/(\d+)\+?\s*(years?|yrs?)\s*(of\s*)?(experience|exp)/gi) || [];
                const maxYears = Math.max(...yearMatches.map(match => {
                    const num = match.match(/\d+/);
                    return num ? parseInt(num[0]) : 0;
                }), 0);

                // Leadership indicators
                const leadershipWords = ['led', 'managed', 'directed', 'supervised', 'mentored', 'team lead', 'senior', 'principal'];
                const leadershipCount = leadershipWords.filter(word => textLower.includes(word)).length;

                // Seniority titles
                const seniorityTitles = ['senior', 'lead', 'principal', 'staff', 'director', 'vp', 'head', 'chief'];
                const hasSeniorTitle = seniorityTitles.some(title => resumeData.personal.title.toLowerCase().includes(title));

                if (maxYears >= 10 || leadershipCount >= 5 || hasSeniorTitle) {
                    return 'senior';
                } else if (maxYears >= 5 || leadershipCount >= 2) {
                    return 'mid';
                } else if (maxYears >= 2) {
                    return 'junior';
                } else {
                    return 'entry';
                }
            }

            // Job Context Analysis
            function analyzeJobContext(jobTitle) {
                const title = jobTitle.toLowerCase();

                const contexts = {
                    'software_engineer': {
                        keywords: ['software', 'developer', 'engineer', 'programmer', 'full stack', 'frontend', 'backend'],
                        skills: ['JavaScript', 'Python', 'Java', 'React', 'Node.js', 'SQL', 'Git', 'AWS', 'Docker', 'Kubernetes'],
                        metrics: ['code quality', 'performance', 'scalability', 'uptime', 'load time', 'bug reduction'],
                        leadership: ['code review', 'mentoring', 'architecture', 'technical lead']
                    },
                    'product_manager': {
                        keywords: ['product', 'manager', 'pm', 'strategy', 'roadmap'],
                        skills: ['Analytics', 'A/B Testing', 'User Research', 'Agile', 'Scrum', 'SQL', 'Tableau', 'Figma'],
                        metrics: ['user growth', 'retention', 'conversion', 'revenue', 'engagement', 'churn'],
                        leadership: ['cross-functional', 'stakeholder', 'vision', 'strategy']
                    },
                    'data_scientist': {
                        keywords: ['data', 'scientist', 'analyst', 'ml', 'machine learning', 'ai'],
                        skills: ['Python', 'R', 'SQL', 'Machine Learning', 'Statistics', 'Tableau', 'TensorFlow', 'Pandas'],
                        metrics: ['model accuracy', 'precision', 'recall', 'data quality', 'insights', 'predictions'],
                        leadership: ['data strategy', 'model deployment', 'team collaboration']
                    },
                    'marketing': {
                        keywords: ['marketing', 'growth', 'digital', 'campaign', 'brand'],
                        skills: ['SEO', 'SEM', 'Analytics', 'Content Marketing', 'Social Media', 'Email Marketing'],
                        metrics: ['conversion rate', 'cac', 'ltv', 'roi', 'engagement', 'reach'],
                        leadership: ['campaign strategy', 'brand management', 'team coordination']
                    },
                    'sales': {
                        keywords: ['sales', 'business development', 'account', 'revenue'],
                        skills: ['CRM', 'Salesforce', 'Prospecting', 'Negotiation', 'Pipeline Management'],
                        metrics: ['quota attainment', 'revenue', 'conversion rate', 'deal size', 'pipeline'],
                        leadership: ['team management', 'territory planning', 'client relationships']
                    }
                };

                for (const [key, context] of Object.entries(contexts)) {
                    if (context.keywords.some(keyword => title.includes(keyword))) {
                        return { type: key, ...context };
                    }
                }

                return {
                    type: 'general',
                    keywords: ['professional', 'manager', 'specialist'],
                    skills: ['Communication', 'Leadership', 'Problem Solving', 'Project Management'],
                    metrics: ['efficiency', 'quality', 'customer satisfaction', 'team performance'],
                    leadership: ['team collaboration', 'process improvement', 'strategic thinking']
                };
            }

            // Resume Analytics
            // ResumeWorded-Exact Analysis System
            function analyzeResume() {
                const text = document.getElementById('resume-preview').innerText;
                const htmlContent = document.getElementById('resume-preview').innerHTML;
                const words = text.split(/\s+/).filter(word => word.length > 0).length;

                // Determine experience level and job context for targeted analysis
                const experienceLevel = determineExperienceLevel(text);
                const jobContext = analyzeJobContext(resumeData.personal.title);

                // Enhanced analysis with experience-level and role-specific metrics
                let analysis = {
                    // Overall score (0-100)
                    overallScore: 0,

                    // Experience and context
                    experienceLevel: experienceLevel,
                    jobContext: jobContext,

                    // Comprehensive categories with experience-level specificity
                    categories: {
                        // CRITICAL ISSUES (High impact on ATS and recruiters)
                        repetition: analyzeRepetition(text),
                        education: analyzeEducation(text),
                        dates: analyzeDates(text),
                        growthSignals: analyzeGrowthSignals(text),
                        jobFit: analyzeJobFit(text),

                        // EXPERIENCE-SPECIFIC METRICS
                        leadershipSignals: analyzeLeadershipSignals(text, experienceLevel),
                        technicalDepth: analyzeTechnicalDepth(text, jobContext),
                        careerProgression: analyzeCareerProgression(text, experienceLevel),
                        industryRelevance: analyzeIndustryRelevance(text, jobContext),
                        responsibilityScope: analyzeResponsibilityScope(text, experienceLevel),

                        // CONTENT QUALITY METRICS
                        impactQuantification: analyzeImpactQuantification(text),
                        actionVerbStrength: analyzeActionVerbStrength(text),
                        skillsRelevance: analyzeSkillsRelevance(text, jobContext, experienceLevel),
                        achievementQuality: analyzeAchievementQuality(text, experienceLevel),
                        metricsRelevance: analyzeMetricsRelevance(text, jobContext, experienceLevel),
                        businessImpactAlignment: analyzeBusinessImpactAlignment(text, jobContext, experienceLevel),

                        // COLLABORATION & PROBLEM-SOLVING METRICS
                        collaborationSignals: analyzeCollaborationSignals(text, experienceLevel),
                        problemSolvingComplexity: analyzeProblemSolvingComplexity(text, experienceLevel),
                        innovationSignals: analyzeInnovationSignals(text, experienceLevel),
                        processImprovementFocus: analyzeProcessImprovementFocus(text, experienceLevel),

                        // ROLE-SPECIFIC METRICS
                        roleSpecificSkills: analyzeRoleSpecificSkills(text, jobContext, experienceLevel),
                        scaleAndComplexity: analyzeScaleAndComplexity(text, experienceLevel),
                        certificationRelevance: analyzeCertificationRelevance(text, jobContext, experienceLevel),

                        // ATS & FORMATTING METRICS
                        atsCompatibility: analyzeATSCompatibility(text, htmlContent),
                        lengthOptimization: analyzeLengthOptimization(text, experienceLevel),
                        sectionStructure: analyzeSectionStructure(experienceLevel),
                        keywordDensity: analyzeKeywordDensity(text, jobContext),

                        // COMPLETED (Things done well)
                        buzzwords: analyzeBuzzwords(text),
                        unnecessarySection: analyzeUnnecessarySection(),
                        contactDetails: analyzeContactDetails(text)
                    },

                    // Additional metrics
                    wordCount: words,
                    sectionCount: resumeData.sections.length,
                    readabilityScore: calculateReadabilityScore(text),

                    // Experience-specific benchmarks
                    benchmarks: getExperienceBenchmarks(experienceLevel, jobContext),

                    // Improvement suggestions
                    suggestions: [],
                    completedItems: [],
                    topFixes: []
                };

                // Calculate weighted overall score based on experience level and job context
                analysis.overallScore = calculateOverallScore(analysis.categories, experienceLevel, jobContext);

                // Generate categorized suggestions
                analysis = generateResumeWordedSuggestions(analysis, text);

                return analysis;
            }

            // ResumeWorded's specific analysis functions
            function analyzeRepetition(text) {
                const words = text.toLowerCase().split(/\s+/);
                const wordCount = {};
                const repetitiveWords = [];

                words.forEach(word => {
                    if (word.length > 4 && !/\d/.test(word)) {
                        wordCount[word] = (wordCount[word] || 0) + 1;
                    }
                });

                Object.entries(wordCount).forEach(([word, count]) => {
                    if (count > 3) {
                        repetitiveWords.push({ word, count });
                    }
                });

                const score = Math.max(0, 10 - repetitiveWords.length * 2);

                return {
                    score,
                    issues: repetitiveWords.length,
                    details: repetitiveWords,
                    status: repetitiveWords.length === 0 ? 'completed' : 'needs_fix',
                    message: repetitiveWords.length > 0 ?
                        `${repetitiveWords.length} words are repeated too often` :
                        'No repetitive words found',
                    priority: repetitiveWords.length > 2 ? 'high' : 'medium'
                };
            }

            function analyzeEducation(text) {
                const educationKeywords = ['bachelor', 'master', 'phd', 'degree', 'university', 'college', 'gpa'];
                const hasEducation = educationKeywords.some(keyword =>
                    text.toLowerCase().includes(keyword)
                );

                const educationSection = resumeData.sections.find(s =>
                    s.title.toLowerCase().includes('education')
                );

                let score = 10;
                let issues = [];

                if (!hasEducation || !educationSection) {
                    score = 0;
                    issues.push('Education section missing or incomplete');
                }

                // Check for GPA (should be removed if < 3.5)
                const gpaMatch = text.match(/gpa[:\s]*([0-9.]+)/i);
                if (gpaMatch && parseFloat(gpaMatch[1]) < 3.5) {
                    score -= 3;
                    issues.push('Remove GPA if below 3.5');
                }

                return {
                    score,
                    issues: issues.length,
                    details: issues,
                    status: issues.length === 0 ? 'completed' : 'needs_fix',
                    message: issues.length === 0 ? 'Education section looks good' : issues[0],
                    priority: 'medium'
                };
            }

            function analyzeDates(text) {
                const datePatterns = [
                    /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}\b/g,
                    /\b\d{1,2}\/\d{4}\b/g,
                    /\b\d{4}\s*-\s*\d{4}\b/g,
                    /\b\d{4}\s*-\s*Present\b/gi
                ];

                let dateCount = 0;
                let inconsistentFormats = false;
                const foundFormats = [];

                datePatterns.forEach((pattern, index) => {
                    const matches = text.match(pattern);
                    if (matches) {
                        dateCount += matches.length;
                        foundFormats.push(index);
                    }
                });

                inconsistentFormats = foundFormats.length > 1;

                let score = 10;
                let issues = [];

                if (dateCount < 2) {
                    score = 0;
                    issues.push('Missing or insufficient date information');
                }

                if (inconsistentFormats) {
                    score -= 5;
                    issues.push('Inconsistent date formatting');
                }

                return {
                    score,
                    issues: issues.length,
                    details: issues,
                    status: issues.length === 0 ? 'completed' : 'needs_fix',
                    message: issues.length === 0 ? 'Date formatting is consistent' : issues[0],
                    priority: 'high'
                };
            }

            function analyzeGrowthSignals(text) {
                const growthWords = [
                    'promoted', 'promotion', 'advanced', 'increased', 'grew', 'expanded',
                    'improved', 'enhanced', 'optimized', 'achieved', 'exceeded',
                    'led', 'managed', 'directed', 'spearheaded'
                ];

                const quantifiers = /\b\d+%|\$\d+|\d+\s*(million|thousand|k|m|billion|x|times)\b/gi;

                const growthMatches = growthWords.filter(word =>
                    text.toLowerCase().includes(word)
                ).length;

                const quantifierMatches = (text.match(quantifiers) || []).length;

                const score = Math.min(10, growthMatches + quantifierMatches);

                return {
                    score,
                    issues: score < 5 ? 1 : 0,
                    details: [`Found ${growthMatches} growth indicators and ${quantifierMatches} quantified achievements`],
                    status: score >= 5 ? 'completed' : 'needs_fix',
                    message: score >= 5 ?
                        'Good use of growth signals and metrics' :
                        'Add more quantified achievements and growth indicators',
                    priority: 'high'
                };
            }

            function analyzeJobFit(text) {
                const jobTitle = resumeData.personal.title.toLowerCase();
                const industryKeywords = getIndustryKeywords(jobTitle);

                const keywordMatches = industryKeywords.filter(keyword =>
                    text.toLowerCase().includes(keyword.toLowerCase())
                ).length;

                const score = Math.min(10, (keywordMatches / industryKeywords.length) * 10);

                return {
                    score,
                    issues: score < 5 ? 1 : 0,
                    details: [`${keywordMatches}/${industryKeywords.length} relevant keywords found`],
                    status: score >= 5 ? 'completed' : 'needs_fix',
                    message: score >= 5 ?
                        'Good keyword optimization for your role' :
                        'Add more industry-specific keywords',
                    priority: 'medium'
                };
            }

            function analyzeBuzzwords(text) {
                const buzzwords = [
                    'synergy', 'leverage', 'utilize', 'facilitate', 'implement',
                    'responsible for', 'duties included', 'hard worker', 'team player'
                ];

                const buzzwordCount = buzzwords.filter(word =>
                    text.toLowerCase().includes(word)
                ).length;

                const score = Math.max(0, 10 - buzzwordCount * 2);

                return {
                    score,
                    issues: buzzwordCount,
                    details: buzzwordCount > 0 ? [`${buzzwordCount} buzzwords found`] : [],
                    status: buzzwordCount === 0 ? 'completed' : 'needs_fix',
                    message: buzzwordCount === 0 ?
                        'No unnecessary buzzwords found' :
                        `Remove ${buzzwordCount} buzzwords and use specific achievements`,
                    priority: 'low'
                };
            }

            function analyzeUnnecessarySection() {
                const unnecessarySections = ['references', 'objective', 'summary'];
                const foundUnnecessary = resumeData.sections.filter(section =>
                    unnecessarySections.some(unnecessary =>
                        section.title.toLowerCase().includes(unnecessary)
                    )
                );

                const score = foundUnnecessary.length === 0 ? 10 : Math.max(0, 10 - foundUnnecessary.length * 5);

                return {
                    score,
                    issues: foundUnnecessary.length,
                    details: foundUnnecessary.map(s => s.title),
                    status: foundUnnecessary.length === 0 ? 'completed' : 'needs_fix',
                    message: foundUnnecessary.length === 0 ?
                        'No unnecessary sections found' :
                        `Remove unnecessary sections: ${foundUnnecessary.map(s => s.title).join(', ')}`,
                    priority: 'low'
                };
            }

            function analyzeContactDetails(text) {
                const hasEmail = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/.test(text);
                const hasPhone = /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/.test(text);
                const hasLocation = resumeData.personal.location && resumeData.personal.location.trim().length > 0;

                let score = 0;
                const details = [];

                if (hasEmail) { score += 4; details.push('Email present'); }
                if (hasPhone) { score += 3; details.push('Phone present'); }
                if (hasLocation) { score += 3; details.push('Location present'); }

                return {
                    score,
                    issues: score < 10 ? 1 : 0,
                    details,
                    status: score >= 8 ? 'completed' : 'needs_fix',
                    message: score >= 8 ?
                        'Contact details are complete' :
                        'Add missing contact information',
                    priority: 'high'
                };
            }

            function calculateOverallScore(categories, experienceLevel, jobContext) {
                // Experience-level and role-specific weights
                const weights = {
                    'entry': {
                        // Core fundamentals for entry-level
                        education: 0.12,
                        atsCompatibility: 0.10,
                        contactDetails: 0.08,
                        skillsRelevance: 0.08,
                        actionVerbStrength: 0.07,
                        lengthOptimization: 0.07,
                        sectionStructure: 0.06,
                        impactQuantification: 0.06,
                        roleSpecificSkills: 0.06,
                        dates: 0.05,
                        keywordDensity: 0.05,
                        repetition: 0.04,
                        responsibilityScope: 0.04,
                        collaborationSignals: 0.03,
                        innovationSignals: 0.03,
                        buzzwords: 0.03,
                        unnecessarySection: 0.03
                    },
                    'junior': {
                        // Growing responsibility and skill demonstration
                        skillsRelevance: 0.10,
                        roleSpecificSkills: 0.09,
                        actionVerbStrength: 0.08,
                        impactQuantification: 0.08,
                        atsCompatibility: 0.08,
                        responsibilityScope: 0.07,
                        collaborationSignals: 0.06,
                        problemSolvingComplexity: 0.06,
                        education: 0.06,
                        lengthOptimization: 0.06,
                        innovationSignals: 0.05,
                        metricsRelevance: 0.05,
                        dates: 0.04,
                        contactDetails: 0.04,
                        keywordDensity: 0.04,
                        repetition: 0.04
                    },
                    'mid': {
                        // Leadership emergence and business impact
                        businessImpactAlignment: 0.12,
                        leadershipSignals: 0.10,
                        achievementQuality: 0.09,
                        impactQuantification: 0.08,
                        collaborationSignals: 0.07,
                        problemSolvingComplexity: 0.07,
                        processImprovementFocus: 0.06,
                        careerProgression: 0.06,
                        roleSpecificSkills: 0.06,
                        metricsRelevance: 0.05,
                        scaleAndComplexity: 0.05,
                        atsCompatibility: 0.05,
                        technicalDepth: 0.04,
                        industryRelevance: 0.04,
                        actionVerbStrength: 0.03,
                        responsibilityScope: 0.03
                    },
                    'senior': {
                        // Strategic leadership and transformation
                        businessImpactAlignment: 0.15,
                        leadershipSignals: 0.12,
                        careerProgression: 0.10,
                        achievementQuality: 0.09,
                        scaleAndComplexity: 0.08,
                        processImprovementFocus: 0.07,
                        collaborationSignals: 0.06,
                        problemSolvingComplexity: 0.06,
                        innovationSignals: 0.05,
                        metricsRelevance: 0.05,
                        technicalDepth: 0.04,
                        industryRelevance: 0.04,
                        impactQuantification: 0.03,
                        responsibilityScope: 0.03,
                        atsCompatibility: 0.03
                    }
                };

                // Role-specific weight adjustments
                const roleAdjustments = {
                    'software_engineer': {
                        technicalDepth: 1.3,
                        roleSpecificSkills: 1.2,
                        problemSolvingComplexity: 1.2,
                        certificationRelevance: 0.8
                    },
                    'product_manager': {
                        businessImpactAlignment: 1.4,
                        collaborationSignals: 1.3,
                        metricsRelevance: 1.2,
                        technicalDepth: 0.7
                    },
                    'data_scientist': {
                        technicalDepth: 1.4,
                        metricsRelevance: 1.3,
                        certificationRelevance: 1.2,
                        problemSolvingComplexity: 1.2
                    },
                    'marketing': {
                        businessImpactAlignment: 1.3,
                        metricsRelevance: 1.2,
                        innovationSignals: 1.1,
                        technicalDepth: 0.8
                    },
                    'sales': {
                        businessImpactAlignment: 1.5,
                        metricsRelevance: 1.3,
                        collaborationSignals: 1.2,
                        technicalDepth: 0.6
                    }
                };

                const levelWeights = weights[experienceLevel] || weights['mid'];
                const roleAdj = roleAdjustments[jobContext?.type] || {};

                let totalScore = 0;
                let totalWeight = 0;

                Object.entries(categories).forEach(([key, category]) => {
                    let weight = levelWeights[key] || 0.02; // Default weight for unlisted metrics

                    // Apply role-specific adjustments
                    if (roleAdj[key]) {
                        weight *= roleAdj[key];
                    }

                    totalScore += category.score * weight;
                    totalWeight += weight;
                });

                return Math.round((totalScore / totalWeight) * 10); // Scale to 0-100
            }

            // Advanced Experience-Level Specific Metrics
            function analyzeLeadershipSignals(text, experienceLevel) {
                const leadershipWords = ['led', 'managed', 'directed', 'supervised', 'mentored', 'coordinated', 'spearheaded', 'guided'];
                const leadershipCount = leadershipWords.filter(word => text.toLowerCase().includes(word)).length;

                // Experience-specific leadership expectations
                const expectations = {
                    'entry': { min: 0, good: 1 },
                    'junior': { min: 1, good: 2 },
                    'mid': { min: 2, good: 4 },
                    'senior': { min: 4, good: 6 }
                };

                const exp = expectations[experienceLevel] || expectations['mid'];
                let score = Math.min(10, (leadershipCount / exp.good) * 10);

                return {
                    score: Math.round(score),
                    issues: leadershipCount < exp.min ? 1 : 0,
                    details: [`${leadershipCount} leadership indicators found`],
                    status: leadershipCount >= exp.min ? 'completed' : 'needs_fix',
                    message: leadershipCount >= exp.good ?
                        `Strong leadership signals for ${experienceLevel} level` :
                        `Add more leadership examples appropriate for ${experienceLevel} level`,
                    priority: experienceLevel === 'senior' ? 'high' : 'medium'
                };
            }

            function analyzeTechnicalDepth(text, jobContext) {
                if (!jobContext.skills) return { score: 10, issues: 0, status: 'completed', message: 'N/A for this role', priority: 'low' };

                const technicalSkills = jobContext.skills;
                const foundSkills = technicalSkills.filter(skill =>
                    text.toLowerCase().includes(skill.toLowerCase())
                ).length;

                const score = Math.min(10, (foundSkills / technicalSkills.length) * 10);

                return {
                    score: Math.round(score),
                    issues: score < 5 ? 1 : 0,
                    details: [`${foundSkills}/${technicalSkills.length} technical skills mentioned`],
                    status: score >= 5 ? 'completed' : 'needs_fix',
                    message: score >= 5 ?
                        'Good technical skill coverage' :
                        'Add more relevant technical skills',
                    priority: 'high'
                };
            }

            function analyzeCareerProgression(text, experienceLevel) {
                const progressionWords = ['promoted', 'advanced', 'grew', 'expanded role', 'increased responsibility'];
                const progressionCount = progressionWords.filter(word => text.toLowerCase().includes(word)).length;

                // Career progression is more important for mid/senior levels
                const importance = {
                    'entry': { weight: 0.5, min: 0 },
                    'junior': { weight: 0.7, min: 0 },
                    'mid': { weight: 1.0, min: 1 },
                    'senior': { weight: 1.2, min: 2 }
                };

                const imp = importance[experienceLevel] || importance['mid'];
                const score = Math.min(10, progressionCount * 3 * imp.weight);

                return {
                    score: Math.round(score),
                    issues: progressionCount < imp.min ? 1 : 0,
                    details: [`${progressionCount} career progression indicators`],
                    status: progressionCount >= imp.min ? 'completed' : 'needs_fix',
                    message: progressionCount >= imp.min ?
                        'Shows clear career progression' :
                        'Highlight career growth and advancement',
                    priority: experienceLevel === 'senior' ? 'high' : 'medium'
                };
            }

            function analyzeIndustryRelevance(text, jobContext) {
                const industryTerms = jobContext.keywords || [];
                const foundTerms = industryTerms.filter(term =>
                    text.toLowerCase().includes(term.toLowerCase())
                ).length;

                const score = Math.min(10, (foundTerms / industryTerms.length) * 10);

                return {
                    score: Math.round(score),
                    issues: score < 6 ? 1 : 0,
                    details: [`${foundTerms}/${industryTerms.length} industry terms found`],
                    status: score >= 6 ? 'completed' : 'needs_fix',
                    message: score >= 6 ?
                        'Well-aligned with industry terminology' :
                        'Add more industry-specific language',
                    priority: 'medium'
                };
            }

            function analyzeImpactQuantification(text) {
                const quantifiers = /\b\d+%|\$[\d,]+|\d+\s*(million|thousand|k|m|billion|users|customers|people|team|projects|years|months|x|times|hours|days)\b/gi;
                const matches = (text.match(quantifiers) || []).length;

                const score = Math.min(10, matches * 1.5);

                return {
                    score: Math.round(score),
                    issues: matches < 3 ? 1 : 0,
                    details: [`${matches} quantified achievements found`],
                    status: matches >= 3 ? 'completed' : 'needs_fix',
                    message: matches >= 3 ?
                        'Good quantification of impact' :
                        'Add specific numbers and metrics to achievements',
                    priority: 'high'
                };
            }

            function analyzeActionVerbStrength(text) {
                const strongVerbs = ['achieved', 'implemented', 'developed', 'led', 'managed', 'created', 'optimized', 'increased', 'reduced', 'delivered', 'spearheaded', 'pioneered'];
                const weakVerbs = ['responsible for', 'worked on', 'helped with', 'assisted', 'participated', 'involved in'];

                const strongCount = strongVerbs.filter(verb => text.toLowerCase().includes(verb)).length;
                const weakCount = weakVerbs.filter(verb => text.toLowerCase().includes(verb)).length;

                const score = Math.min(10, Math.max(0, strongCount * 2 - weakCount));

                return {
                    score: Math.round(score),
                    issues: strongCount < 4 ? 1 : 0,
                    details: [`${strongCount} strong verbs, ${weakCount} weak phrases`],
                    status: strongCount >= 4 ? 'completed' : 'needs_fix',
                    message: strongCount >= 4 ?
                        'Strong action verb usage' :
                        'Replace weak phrases with strong action verbs',
                    priority: 'high'
                };
            }

            function analyzeSkillsRelevance(text, jobContext, experienceLevel) {
                const relevantSkills = jobContext.skills || [];
                const foundSkills = relevantSkills.filter(skill =>
                    text.toLowerCase().includes(skill.toLowerCase())
                ).length;

                // Experience level affects skill expectations
                const skillExpectations = {
                    'entry': 0.4,
                    'junior': 0.5,
                    'mid': 0.6,
                    'senior': 0.7
                };

                const expectedRatio = skillExpectations[experienceLevel] || 0.5;
                const actualRatio = foundSkills / relevantSkills.length;
                const score = Math.min(10, (actualRatio / expectedRatio) * 10);

                return {
                    score: Math.round(score),
                    issues: actualRatio < expectedRatio ? 1 : 0,
                    details: [`${foundSkills}/${relevantSkills.length} relevant skills (${Math.round(actualRatio * 100)}%)`],
                    status: actualRatio >= expectedRatio ? 'completed' : 'needs_fix',
                    message: actualRatio >= expectedRatio ?
                        `Skills well-aligned for ${experienceLevel} level` :
                        `Add more skills relevant to ${experienceLevel} ${jobContext.type} role`,
                    priority: 'medium'
                };
            }

            function analyzeAchievementQuality(text, experienceLevel) {
                const impactWords = ['improved', 'increased', 'reduced', 'saved', 'generated', 'achieved', 'exceeded', 'delivered', 'transformed', 'optimized'];
                const impactCount = impactWords.filter(word => text.toLowerCase().includes(word)).length;

                // Higher expectations for senior levels
                const expectations = {
                    'entry': { min: 2, good: 4 },
                    'junior': { min: 3, good: 5 },
                    'mid': { min: 4, good: 7 },
                    'senior': { min: 6, good: 10 }
                };

                const exp = expectations[experienceLevel] || expectations['mid'];
                const score = Math.min(10, (impactCount / exp.good) * 10);

                return {
                    score: Math.round(score),
                    issues: impactCount < exp.min ? 1 : 0,
                    details: [`${impactCount} impact-focused achievements`],
                    status: impactCount >= exp.min ? 'completed' : 'needs_fix',
                    message: impactCount >= exp.good ?
                        `Excellent achievement quality for ${experienceLevel} level` :
                        `Add more impactful achievements for ${experienceLevel} level`,
                    priority: 'high'
                };
            }

            function analyzeATSCompatibility(text, htmlContent) {
                let score = 10;
                let issues = [];

                // Check for ATS-unfriendly elements
                const specialChars = /[]/g;
                const specialCharCount = (text.match(specialChars) || []).length;

                if (specialCharCount > 5) {
                    score -= 2;
                    issues.push('Too many special characters for ATS');
                }

                if (htmlContent.includes('<img')) {
                    score -= 3;
                    issues.push('Images may not be parsed by ATS');
                }

                if (htmlContent.includes('<table')) {
                    score -= 2;
                    issues.push('Tables can cause ATS parsing issues');
                }

                return {
                    score: Math.max(0, score),
                    issues: issues.length,
                    details: issues,
                    status: issues.length === 0 ? 'completed' : 'needs_fix',
                    message: issues.length === 0 ? 'Resume is ATS-compatible' : 'Improve ATS compatibility',
                    priority: 'high'
                };
            }

            function analyzeResponsibilityScope(text, experienceLevel) {
                const scopeIndicators = {
                    'entry': ['assisted', 'supported', 'contributed', 'participated', 'learned', 'developed skills'],
                    'junior': ['executed', 'implemented', 'maintained', 'collaborated', 'delivered', 'completed'],
                    'mid': ['owned', 'designed', 'architected', 'optimized', 'coordinated', 'improved'],
                    'senior': ['strategized', 'transformed', 'pioneered', 'scaled', 'established', 'revolutionized']
                };

                const expectedWords = scopeIndicators[experienceLevel] || scopeIndicators['mid'];
                const foundWords = expectedWords.filter(word => text.toLowerCase().includes(word)).length;
                const score = Math.min(10, (foundWords / expectedWords.length) * 15);

                return {
                    score: Math.round(score),
                    issues: foundWords < 2 ? 1 : 0,
                    details: [`${foundWords}/${expectedWords.length} responsibility indicators for ${experienceLevel} level`],
                    status: foundWords >= 2 ? 'completed' : 'needs_fix',
                    message: foundWords >= 2 ?
                        `Appropriate responsibility scope for ${experienceLevel} level` :
                        `Add more ${experienceLevel}-level responsibility indicators`,
                    priority: 'high'
                };
            }

            function analyzeMetricsRelevance(text, jobContext, experienceLevel) {
                const relevantMetrics = jobContext.metrics || [];
                const foundMetrics = relevantMetrics.filter(metric =>
                    text.toLowerCase().includes(metric.toLowerCase())
                ).length;

                // Higher expectations for senior roles
                const metricExpectations = {
                    'entry': { min: 1, good: 2 },
                    'junior': { min: 2, good: 3 },
                    'mid': { min: 3, good: 5 },
                    'senior': { min: 4, good: 6 }
                };

                const exp = metricExpectations[experienceLevel] || metricExpectations['mid'];
                const score = Math.min(10, (foundMetrics / exp.good) * 10);

                return {
                    score: Math.round(score),
                    issues: foundMetrics < exp.min ? 1 : 0,
                    details: [`${foundMetrics} relevant metrics mentioned`],
                    status: foundMetrics >= exp.min ? 'completed' : 'needs_fix',
                    message: foundMetrics >= exp.good ?
                        'Excellent use of relevant metrics' :
                        `Add more ${jobContext.type}-specific metrics`,
                    priority: 'high'
                };
            }

            function analyzeCollaborationSignals(text, experienceLevel) {
                const collaborationWords = ['collaborated', 'partnered', 'worked with', 'cross-functional', 'stakeholders', 'team', 'coordinated'];
                const collaborationCount = collaborationWords.filter(word => text.toLowerCase().includes(word)).length;

                // Collaboration becomes more important at higher levels
                const expectations = {
                    'entry': { min: 1, weight: 0.8 },
                    'junior': { min: 2, weight: 1.0 },
                    'mid': { min: 3, weight: 1.2 },
                    'senior': { min: 4, weight: 1.5 }
                };

                const exp = expectations[experienceLevel] || expectations['mid'];
                const score = Math.min(10, collaborationCount * 2 * exp.weight);

                return {
                    score: Math.round(score),
                    issues: collaborationCount < exp.min ? 1 : 0,
                    details: [`${collaborationCount} collaboration indicators`],
                    status: collaborationCount >= exp.min ? 'completed' : 'needs_fix',
                    message: collaborationCount >= exp.min ?
                        'Good collaboration emphasis' :
                        'Highlight more collaborative achievements',
                    priority: experienceLevel === 'senior' ? 'high' : 'medium'
                };
            }

            function analyzeProblemSolvingComplexity(text, experienceLevel) {
                const complexityWords = {
                    'entry': ['solved', 'fixed', 'resolved', 'debugged', 'troubleshot'],
                    'junior': ['analyzed', 'investigated', 'identified', 'diagnosed', 'optimized'],
                    'mid': ['architected', 'designed', 'engineered', 'refactored', 'streamlined'],
                    'senior': ['strategized', 'transformed', 'innovated', 'revolutionized', 'pioneered']
                };

                const levelWords = complexityWords[experienceLevel] || complexityWords['mid'];
                const foundWords = levelWords.filter(word => text.toLowerCase().includes(word)).length;
                const score = Math.min(10, (foundWords / levelWords.length) * 12);

                return {
                    score: Math.round(score),
                    issues: foundWords < 2 ? 1 : 0,
                    details: [`${foundWords} problem-solving indicators at ${experienceLevel} complexity`],
                    status: foundWords >= 2 ? 'completed' : 'needs_fix',
                    message: foundWords >= 2 ?
                        `Appropriate problem-solving complexity for ${experienceLevel}` :
                        `Add more complex problem-solving examples for ${experienceLevel} level`,
                    priority: 'medium'
                };
            }

            function analyzeBusinessImpactAlignment(text, jobContext, experienceLevel) {
                const businessWords = ['revenue', 'profit', 'cost', 'efficiency', 'roi', 'growth', 'market', 'customer', 'business'];
                const businessCount = businessWords.filter(word => text.toLowerCase().includes(word)).length;

                // Business impact becomes critical at higher levels
                const impactExpectations = {
                    'entry': { min: 1, multiplier: 1.0 },
                    'junior': { min: 2, multiplier: 1.2 },
                    'mid': { min: 3, multiplier: 1.5 },
                    'senior': { min: 5, multiplier: 2.0 }
                };

                const exp = impactExpectations[experienceLevel] || impactExpectations['mid'];
                const score = Math.min(10, businessCount * exp.multiplier);

                return {
                    score: Math.round(score),
                    issues: businessCount < exp.min ? 1 : 0,
                    details: [`${businessCount} business impact indicators`],
                    status: businessCount >= exp.min ? 'completed' : 'needs_fix',
                    message: businessCount >= exp.min ?
                        'Strong business impact focus' :
                        'Add more business impact examples',
                    priority: experienceLevel === 'senior' ? 'critical' : 'high'
                };
            }

            function analyzeInnovationSignals(text, experienceLevel) {
                const innovationWords = ['created', 'developed', 'built', 'launched', 'introduced', 'pioneered', 'innovated', 'established'];
                const innovationCount = innovationWords.filter(word => text.toLowerCase().includes(word)).length;

                // Innovation expectations scale with experience
                const expectations = {
                    'entry': { min: 1, good: 2 },
                    'junior': { min: 2, good: 3 },
                    'mid': { min: 3, good: 5 },
                    'senior': { min: 4, good: 7 }
                };

                const exp = expectations[experienceLevel] || expectations['mid'];
                const score = Math.min(10, (innovationCount / exp.good) * 10);

                return {
                    score: Math.round(score),
                    issues: innovationCount < exp.min ? 1 : 0,
                    details: [`${innovationCount} innovation indicators`],
                    status: innovationCount >= exp.min ? 'completed' : 'needs_fix',
                    message: innovationCount >= exp.good ?
                        'Excellent innovation showcase' :
                        'Highlight more innovative contributions',
                    priority: 'medium'
                };
            }

            function analyzeProcessImprovementFocus(text, experienceLevel) {
                const processWords = ['improved', 'optimized', 'streamlined', 'automated', 'enhanced', 'standardized', 'implemented'];
                const processCount = processWords.filter(word => text.toLowerCase().includes(word)).length;

                // Process improvement becomes more important at mid+ levels
                const processExpectations = {
                    'entry': { min: 1, weight: 0.8 },
                    'junior': { min: 2, weight: 1.0 },
                    'mid': { min: 3, weight: 1.3 },
                    'senior': { min: 4, weight: 1.6 }
                };

                const exp = processExpectations[experienceLevel] || processExpectations['mid'];
                const score = Math.min(10, processCount * 1.5 * exp.weight);

                return {
                    score: Math.round(score),
                    issues: processCount < exp.min ? 1 : 0,
                    details: [`${processCount} process improvement indicators`],
                    status: processCount >= exp.min ? 'completed' : 'needs_fix',
                    message: processCount >= exp.min ?
                        'Good process improvement focus' :
                        'Add more process improvement examples',
                    priority: experienceLevel === 'senior' ? 'high' : 'medium'
                };
            }

            function analyzeRoleSpecificSkills(text, jobContext, experienceLevel) {
                const roleSkills = jobContext.skills || [];
                const foundSkills = roleSkills.filter(skill =>
                    text.toLowerCase().includes(skill.toLowerCase())
                ).length;

                // Skill depth expectations by level
                const skillDepthExpectations = {
                    'entry': { ratio: 0.3, depth: 'basic' },
                    'junior': { ratio: 0.4, depth: 'intermediate' },
                    'mid': { ratio: 0.6, depth: 'advanced' },
                    'senior': { ratio: 0.7, depth: 'expert' }
                };

                const exp = skillDepthExpectations[experienceLevel] || skillDepthExpectations['mid'];
                const actualRatio = foundSkills / roleSkills.length;
                const score = Math.min(10, (actualRatio / exp.ratio) * 10);

                return {
                    score: Math.round(score),
                    issues: actualRatio < exp.ratio ? 1 : 0,
                    details: [`${foundSkills}/${roleSkills.length} role-specific skills (${Math.round(actualRatio * 100)}%)`],
                    status: actualRatio >= exp.ratio ? 'completed' : 'needs_fix',
                    message: actualRatio >= exp.ratio ?
                        `Strong ${exp.depth} skill demonstration` :
                        `Add more ${exp.depth}-level ${jobContext.type} skills`,
                    priority: 'high'
                };
            }

            function analyzeScaleAndComplexity(text, experienceLevel) {
                const scaleWords = ['enterprise', 'large-scale', 'global', 'million', 'thousand', 'complex', 'multi-', 'cross-'];
                const scaleCount = scaleWords.filter(word => text.toLowerCase().includes(word)).length;

                // Scale expectations increase with experience
                const scaleExpectations = {
                    'entry': { min: 0, good: 1 },
                    'junior': { min: 1, good: 2 },
                    'mid': { min: 2, good: 4 },
                    'senior': { min: 3, good: 6 }
                };

                const exp = scaleExpectations[experienceLevel] || scaleExpectations['mid'];
                const score = Math.min(10, (scaleCount / exp.good) * 10);

                return {
                    score: Math.round(score),
                    issues: scaleCount < exp.min ? 1 : 0,
                    details: [`${scaleCount} scale/complexity indicators`],
                    status: scaleCount >= exp.min ? 'completed' : 'needs_fix',
                    message: scaleCount >= exp.good ?
                        'Excellent scale demonstration' :
                        'Highlight work scale and complexity',
                    priority: experienceLevel === 'senior' ? 'high' : 'medium'
                };
            }

            function analyzeCertificationRelevance(text, jobContext, experienceLevel) {
                const certificationWords = ['certified', 'certification', 'license', 'credential', 'accredited'];
                const certCount = certificationWords.filter(word => text.toLowerCase().includes(word)).length;

                // Certification importance varies by role and level
                const certImportance = {
                    'software_engineer': { weight: 0.8, min: 0 },
                    'data_scientist': { weight: 1.2, min: 1 },
                    'product_manager': { weight: 0.6, min: 0 },
                    'marketing': { weight: 1.0, min: 0 },
                    'sales': { weight: 0.7, min: 0 }
                };

                const importance = certImportance[jobContext.type] || { weight: 0.8, min: 0 };
                const score = Math.min(10, certCount * 3 * importance.weight);

                return {
                    score: Math.round(score),
                    issues: certCount < importance.min ? 1 : 0,
                    details: [`${certCount} certifications mentioned`],
                    status: certCount >= importance.min ? 'completed' : 'needs_fix',
                    message: certCount > 0 ?
                        'Good certification showcase' :
                        'Consider adding relevant certifications',
                    priority: importance.weight > 1.0 ? 'medium' : 'low'
                };
            }

            function analyzeKeywordDensity(text, jobContext) {
                const keywords = jobContext.keywords || [];
                const keywordMatches = keywords.filter(keyword =>
                    text.toLowerCase().includes(keyword.toLowerCase())
                ).length;

                const density = keywords.length > 0 ? (keywordMatches / keywords.length) * 100 : 100;
                const score = Math.min(10, density / 10);

                return {
                    score: Math.round(score),
                    issues: density < 50 ? 1 : 0,
                    details: [`${Math.round(density)}% keyword density`],
                    status: density >= 50 ? 'completed' : 'needs_fix',
                    message: density >= 50 ?
                        'Good keyword optimization' :
                        'Improve keyword density for better ATS matching',
                    priority: 'medium'
                };
            }

            function analyzeResumeLength(text, experienceLevel) {
                const wordCount = text.split(/\s+/).length;
                let score = 10;
                let issues = [];

                // Experience-specific length expectations
                const lengthExpectations = {
                    'entry': { min: 200, max: 400, optimal: 300 },
                    'junior': { min: 300, max: 500, optimal: 400 },
                    'mid': { min: 400, max: 600, optimal: 500 },
                    'senior': { min: 500, max: 800, optimal: 650 }
                };

                const expectations = lengthExpectations[experienceLevel] || lengthExpectations['mid'];

                if (wordCount < expectations.min) {
                    score = 3;
                    issues.push(`Resume too short for ${experienceLevel} level - add more detail`);
                } else if (wordCount > expectations.max) {
                    score = 6;
                    issues.push(`Resume too long for ${experienceLevel} level - consider condensing`);
                } else if (Math.abs(wordCount - expectations.optimal) > 100) {
                    score = 8;
                    issues.push('Could optimize length for better impact');
                }

                return {
                    score,
                    issues: issues.length,
                    details: issues,
                    status: issues.length === 0 ? 'completed' : 'needs_fix',
                    message: issues.length === 0 ? `Resume length is optimal for ${experienceLevel} level` : issues[0],
                    priority: 'medium'
                };
            }

            function analyzeLengthOptimization(text, experienceLevel) {
                return analyzeResumeLength(text, experienceLevel);
            }

            function analyzeSectionStructure(experienceLevel) {
                const requiredSections = ['experience', 'education', 'skills'];
                const optionalSections = ['projects', 'certifications', 'awards'];

                const sectionTitles = resumeData.sections.map(s => s.title.toLowerCase());
                const hasRequired = requiredSections.every(req =>
                    sectionTitles.some(title => title.includes(req))
                );

                const optionalCount = optionalSections.filter(opt =>
                    sectionTitles.some(title => title.includes(opt))
                ).length;

                let score = hasRequired ? 7 : 3;
                score += Math.min(3, optionalCount);

                return {
                    score,
                    issues: !hasRequired ? 1 : 0,
                    details: [`${sectionTitles.length} sections, ${optionalCount} optional sections`],
                    status: hasRequired ? 'completed' : 'needs_fix',
                    message: hasRequired ?
                        'Good section structure' :
                        'Add required sections (Experience, Education, Skills)',
                    priority: 'medium'
                };
            }

            function getExperienceBenchmarks(experienceLevel, jobContext) {
                const baseBenchmarks = {
                    'entry': {
                        wordCount: '200-400 words',
                        sections: '4-5 sections',
                        achievements: '2-4 quantified achievements',
                        leadership: '0-1 leadership examples',
                        skills: '5-8 relevant skills',
                        experience: '0-2 years',
                        focus: 'Education, internships, projects, basic skills'
                    },
                    'junior': {
                        wordCount: '300-500 words',
                        sections: '5-6 sections',
                        achievements: '3-5 quantified achievements',
                        leadership: '1-2 leadership examples',
                        skills: '8-12 relevant skills',
                        experience: '2-4 years',
                        focus: 'Growing responsibility, skill development, collaboration'
                    },
                    'mid': {
                        wordCount: '400-600 words',
                        sections: '6-7 sections',
                        achievements: '4-7 quantified achievements',
                        leadership: '2-4 leadership examples',
                        skills: '10-15 relevant skills',
                        experience: '4-8 years',
                        focus: 'Leadership, process improvement, business impact'
                    },
                    'senior': {
                        wordCount: '500-800 words',
                        sections: '7-8 sections',
                        achievements: '6-10 quantified achievements',
                        leadership: '4+ leadership examples',
                        skills: '12-20 relevant skills',
                        experience: '8+ years',
                        focus: 'Strategic leadership, transformation, mentoring'
                    }
                };

                const roleBenchmarks = {
                    'software_engineer': {
                        keyMetrics: 'Performance improvements, code quality, system scalability',
                        certifications: 'AWS, Azure, Google Cloud (optional)',
                        projects: 'Open source contributions, side projects'
                    },
                    'product_manager': {
                        keyMetrics: 'User growth, retention, conversion rates, revenue impact',
                        certifications: 'Product Management, Agile/Scrum',
                        projects: 'Product launches, feature development'
                    },
                    'data_scientist': {
                        keyMetrics: 'Model accuracy, data insights, business value',
                        certifications: 'Machine Learning, Statistics, Cloud platforms',
                        projects: 'ML models, data analysis, research'
                    },
                    'marketing': {
                        keyMetrics: 'Campaign ROI, lead generation, brand awareness',
                        certifications: 'Google Analytics, HubSpot, Facebook Ads',
                        projects: 'Campaign results, content strategy'
                    },
                    'sales': {
                        keyMetrics: 'Quota attainment, revenue growth, pipeline management',
                        certifications: 'Salesforce, sales methodology training',
                        projects: 'Territory expansion, client relationships'
                    }
                };

                const levelBenchmarks = baseBenchmarks[experienceLevel] || baseBenchmarks['mid'];
                const roleBenchmarks_specific = roleBenchmarks[jobContext.type] || {
                    keyMetrics: 'Performance improvements, efficiency gains',
                    certifications: 'Industry-relevant certifications',
                    projects: 'Professional accomplishments'
                };

                return {
                    ...levelBenchmarks,
                    ...roleBenchmarks_specific,
                    experienceLevel: experienceLevel,
                    jobType: jobContext.type
                };
            }

            function generateResumeWordedSuggestions(analysis, text) {
                // Categorize issues
                Object.entries(analysis.categories).forEach(([key, category]) => {
                    if (category.status === 'completed') {
                        analysis.completedItems.push({
                            name: key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1'),
                            score: category.score,
                            message: category.message
                        });
                    } else {
                        analysis.topFixes.push({
                            name: key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1'),
                            score: category.score,
                            issues: category.issues,
                            message: category.message,
                            priority: category.priority,
                            details: category.details
                        });
                    }
                });

                // Sort by priority and score
                analysis.topFixes.sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority] || a.score - b.score;
                });

                return analysis;
            }

            function calculateReadabilityScore(text) {
                const sentences = text.split(/[.!?]+/).length;
                const words = text.split(/\s+/).length;
                const avgWordsPerSentence = words / sentences;

                // Simple readability score (higher is better, max 100)
                return Math.max(0, Math.min(100, 100 - (avgWordsPerSentence - 15) * 2));
            }

            // ATS Score Calculation (ResumeWorded methodology)
            function calculateATSScore(text, htmlContent) {
                let score = 100;
                const issues = [];

                // 1. File Format & Structure (20 points)
                if (htmlContent && htmlContent.includes('<table')) {
                    score -= 15;
                    issues.push('Tables detected - may cause ATS parsing issues');
                }
                if (htmlContent && htmlContent.includes('background-image')) {
                    score -= 10;
                    issues.push('Background images may not be ATS-friendly');
                }

                // 2. Contact Information (15 points)
                const hasEmail = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/.test(text);
                const hasPhone = /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/.test(text);
                if (!hasEmail) { score -= 8; issues.push('Email address missing or not properly formatted'); }
                if (!hasPhone) { score -= 7; issues.push('Phone number missing or not properly formatted'); }

                // 3. Section Headers (15 points)
                const requiredSections = ['experience', 'education', 'skills'];
                const sectionTitles = resumeData.sections.map(s => s.title.toLowerCase());
                requiredSections.forEach(section => {
                    if (!sectionTitles.some(title => title.includes(section))) {
                        score -= 5;
                        issues.push(`Missing ${section} section`);
                    }
                });

                // 4. Keywords & Industry Terms (20 points)
                const jobTitle = resumeData.personal.title.toLowerCase();
                const industryKeywords = getIndustryKeywords(jobTitle);
                const keywordMatches = industryKeywords.filter(keyword =>
                    text.toLowerCase().includes(keyword.toLowerCase())
                ).length;
                const keywordScore = Math.min(20, (keywordMatches / industryKeywords.length) * 20);
                score = score - 20 + keywordScore;

                // 5. Formatting & Special Characters (10 points)
                const specialChars = /[]/g;
                const specialCharCount = (text.match(specialChars) || []).length;
                if (specialCharCount > 5) {
                    score -= 5;
                    issues.push('Too many special characters - use simple bullets');
                }

                // 6. Date Formatting (10 points)
                const dateFormats = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}\b|\b\d{1,2}\/\d{4}\b|\b\d{4}\s*-\s*\d{4}\b/g;
                const dateCount = (text.match(dateFormats) || []).length;
                if (dateCount < 2) {
                    score -= 5;
                    issues.push('Inconsistent or missing date formatting');
                }

                // 7. Length & Content Density (10 points)
                if (text.length < 1000) { score -= 5; issues.push('Resume too short - add more detail'); }
                if (text.length > 4000) { score -= 5; issues.push('Resume too long - consider condensing'); }

                return Math.max(0, Math.round(score));
            }

            // Impact Score (measures achievement-focused language)
            function calculateImpactScore(text) {
                let score = 0;
                const impactWords = [
                    'achieved', 'improved', 'increased', 'decreased', 'reduced', 'generated',
                    'saved', 'delivered', 'exceeded', 'optimized', 'streamlined', 'launched',
                    'led', 'managed', 'directed', 'spearheaded', 'pioneered', 'transformed'
                ];

                const quantifiers = /\b\d+%|\$\d+|\d+\s*(million|thousand|k|m|billion|users|customers|people|team|projects|years|months)\b/gi;
                const quantifierMatches = (text.match(quantifiers) || []).length;

                const impactMatches = impactWords.filter(word =>
                    text.toLowerCase().includes(word)
                ).length;

                // Score based on impact words and quantification
                score = Math.min(100, (impactMatches * 5) + (quantifierMatches * 10));

                return Math.round(score);
            }

            // Get industry-specific keywords
            function getIndustryKeywords(jobTitle) {
                const keywordMap = {
                    'software engineer': ['JavaScript', 'Python', 'React', 'Node.js', 'API', 'Database', 'Git', 'Agile', 'Testing', 'DevOps'],
                    'product manager': ['Product Strategy', 'Roadmap', 'Stakeholder', 'Analytics', 'A/B Testing', 'User Research', 'Agile', 'Scrum', 'KPIs', 'Growth'],
                    'data scientist': ['Machine Learning', 'Python', 'SQL', 'Statistics', 'Analytics', 'Visualization', 'Big Data', 'AI', 'Modeling', 'Research'],
                    'marketing': ['Campaign', 'SEO', 'Analytics', 'Content', 'Social Media', 'Brand', 'Lead Generation', 'Conversion', 'ROI', 'Strategy'],
                    'sales': ['Revenue', 'Pipeline', 'CRM', 'Prospecting', 'Closing', 'Quota', 'Territory', 'Relationship', 'Negotiation', 'Growth']
                };

                for (const [role, keywords] of Object.entries(keywordMap)) {
                    if (jobTitle.includes(role)) {
                        return keywords;
                    }
                }

                return ['Leadership', 'Management', 'Strategy', 'Analysis', 'Communication', 'Problem Solving', 'Innovation', 'Results', 'Collaboration', 'Excellence'];
            }

            // Additional helper functions for comprehensive analysis
            function getATSBreakdown(text, htmlContent) {
                return {
                    fileFormat: {
                        score: (htmlContent && htmlContent.includes('<table')) ? 70 : 95,
                        issues: (htmlContent && htmlContent.includes('<table')) ? ['Tables detected'] : []
                    },
                    contactInfo: {
                        score: (/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/.test(text) && /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/.test(text)) ? 95 : 60,
                        issues: []
                    },
                    sectionHeaders: {
                        score: resumeData.sections.length >= 4 ? 90 : 70,
                        issues: resumeData.sections.length < 4 ? ['Add more sections'] : []
                    },
                    keywords: {
                        score: getKeywordDensity(text).score,
                        issues: getKeywordDensity(text).issues
                    },
                    formatting: {
                        score: getFormattingScore(htmlContent),
                        issues: []
                    }
                };
            }

            function getContentAnalysis(text) {
                const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const avgSentenceLength = sentences.length > 0 ? sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length : 0;

                return {
                    sentences: sentences.length,
                    avgSentenceLength: Math.round(avgSentenceLength),
                    passiveVoice: countPassiveVoice(text),
                    actionVerbs: countActionVerbs(text),
                    repetitiveWords: findRepetitiveWords(text),
                    readingLevel: getReadingLevel(text)
                };
            }

            function getKeywordDensity(text) {
                const jobTitle = resumeData.personal.title.toLowerCase();
                const industryKeywords = getIndustryKeywords(jobTitle);
                const textLower = text.toLowerCase();

                const foundKeywords = industryKeywords.filter(keyword =>
                    textLower.includes(keyword.toLowerCase())
                );

                const density = industryKeywords.length > 0 ? (foundKeywords.length / industryKeywords.length) * 100 : 0;

                return {
                    score: Math.round(density),
                    foundKeywords,
                    missingKeywords: industryKeywords.filter(k => !foundKeywords.includes(k)),
                    issues: density < 30 ? ['Low keyword density - add more industry-specific terms'] : []
                };
            }

            function countPassiveVoice(text) {
                const passivePatterns = /\b(was|were|been|being)\s+\w+ed\b/gi;
                return (text.match(passivePatterns) || []).length;
            }

            function countActionVerbs(text) {
                const actionVerbs = Object.values(aiSuggestions.actionVerbs).flat();
                return actionVerbs.filter(verb =>
                    text.toLowerCase().includes(verb.toLowerCase())
                ).length;
            }

            function findRepetitiveWords(text) {
                const words = text.toLowerCase().split(/\s+/);
                const wordCount = {};
                words.forEach(word => {
                    if (word.length > 4) {
                        wordCount[word] = (wordCount[word] || 0) + 1;
                    }
                });

                return Object.entries(wordCount)
                    .filter(([word, count]) => count > 3)
                    .map(([word, count]) => ({ word, count }));
            }

            function getReadingLevel(text) {
                const sentences = text.split(/[.!?]+/).length;
                const words = text.split(/\s+/).length;
                const syllables = countSyllables(text);

                if (sentences === 0 || words === 0) return 'Standard';

                // Flesch Reading Ease Score
                const score = 206.835 - (1.015 * (words / sentences)) - (84.6 * (syllables / words));

                if (score >= 90) return 'Very Easy';
                if (score >= 80) return 'Easy';
                if (score >= 70) return 'Fairly Easy';
                if (score >= 60) return 'Standard';
                if (score >= 50) return 'Fairly Difficult';
                if (score >= 30) return 'Difficult';
                return 'Very Difficult';
            }

            function countSyllables(text) {
                return text.toLowerCase()
                    .replace(/[^a-z]/g, '')
                    .replace(/[aeiou]{2,}/g, 'a')
                    .replace(/[^aeiou]/g, '')
                    .length || 1;
            }

            function getFormattingScore(htmlContent) {
                if (!htmlContent) return 100;

                let score = 100;

                if (htmlContent.includes('font-family')) score -= 5;
                if (htmlContent.includes('color:')) score -= 5;
                if (htmlContent.includes('<img')) score -= 10;
                if (htmlContent.includes('<table')) score -= 15;

                return Math.max(0, score);
            }

            function generateComprehensiveSuggestions(analysis, text) {
                const suggestions = [];

                // ATS-specific suggestions
                if (analysis.atsScore < 80) {
                    suggestions.push('Improve ATS compatibility by using standard section headers and avoiding complex formatting');
                }

                // Content suggestions
                if (analysis.impactScore < 60) {
                    suggestions.push('Add more quantifiable achievements with specific numbers and percentages');
                }

                if (analysis.contentAnalysis.actionVerbs < 5) {
                    suggestions.push('Use more strong action verbs to start your bullet points');
                }

                if (analysis.keywordDensity.score < 30) {
                    suggestions.push(`Add more industry-specific keywords: ${analysis.keywordDensity.missingKeywords.slice(0, 3).join(', ')}`);
                }

                // Length suggestions
                if (analysis.wordCount < 200) {
                    suggestions.push('Expand your resume with more detailed descriptions of your achievements');
                } else if (analysis.wordCount > 600) {
                    suggestions.push('Consider condensing your resume to focus on the most impactful achievements');
                }

                return suggestions;
            }

            // Notification System
            function showNotification(message, type = 'info', duration = 3000) {
                try {
                    const notification = document.createElement('div');
                    let bgClass = 'bg-blue-500 text-white';
                    if (type === 'success') bgClass = 'bg-green-500 text-white';
                    else if (type === 'error') bgClass = 'bg-red-500 text-white';
                    else if (type === 'warning') bgClass = 'bg-yellow-500 text-black';

                    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${bgClass}`;
                    notification.textContent = message;

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }, duration);
                } catch (error) {
                    console.log(message); // Fallback
                }
            }

            // Enhanced AI Analysis with modern UI
            window.handleAiAnalysis = async function () {
                // Show modal with loading state
                aiModal.classList.remove('hidden');
                const progressBar = document.getElementById('progress-bar');
                const progressIndicator = document.getElementById('analysis-progress');

                // Show progress indicator
                progressIndicator.classList.remove('hidden');
                aiFeedbackEl.innerHTML = '';

                // Animate progress bar
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                }, 200);

                try {

                    // Client-side analysis
                    const analysis = analyzeResume();
                    const suggestions = getSmartSuggestions(document.getElementById('resume-preview').innerText, 'general');

                    // Complete progress and hide indicator
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressIndicator.classList.add('hidden');
                    }, 500);

                    // Generate enhanced feedback with modern UI
                    let feedback = `
                    <div class="space-y-6 animate-slide-up">
                        <!-- ResumeWorded-Exact Interface -->
                        <div class="suggestion-card">
                            <!-- Header with Overall Score -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <div class="relative w-20 h-20 mr-6">
                                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
                                            <path class="text-gray-300" stroke="currentColor" stroke-width="3" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                            <path class="text-orange-500" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="${analysis.overallScore}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-gray-800">${analysis.overallScore}</div>
                                                <div class="text-xs text-gray-500 uppercase tracking-wide">Overall</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800 mb-1">Your resume scored ${analysis.overallScore} out of 100.</h3>
                                        <p class="text-gray-600">You're on the right track, but there's room for improvement on your resume!</p>
                                        <div class="mt-2 text-sm text-gray-500">
                                            <span class="inline-flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                Your score is benchmarked against 1m+ resumes at your career level
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Score Bar -->
                            <div class="mb-6">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>0</span>
                                    <span class="font-medium">YOUR RESUME</span>
                                    <span>TOP RESUMES</span>
                                </div>
                                <div class="relative h-3 bg-gradient-to-r from-red-400 via-yellow-400 via-green-400 to-green-600 rounded-full">
                                    <div class="absolute top-0 h-3 w-1 bg-blue-600 rounded-full" style="left: ${analysis.overallScore}%;">
                                        <div class="absolute -top-2 left-1/2 transform -translate-x-1/2">
                                            <div class="w-0 h-0 border-l-2 border-r-2 border-b-4 border-transparent border-b-blue-600"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Fixes Section -->
                        ${analysis.topFixes.length > 0 ? `
                        <div class="suggestion-card">
                            <div class="mb-4">
                                <h4 class="font-bold text-lg text-red-600 mb-2"> TOP FIXES</h4>
                                <p class="text-gray-600 text-sm">Here are some recruiter checks that are bringing your score down. Click into each to learn where you went wrong and how to improve your score.</p>
                            </div>
                            <div class="space-y-3">
                                ${analysis.topFixes.map(fix => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors cursor-pointer">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                                ${fix.issues}
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800">${fix.name}</div>
                                                <div class="text-sm text-gray-600">${fix.message}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-medium text-red-600">${fix.score}/10</div>
                                            <div class="text-xs text-gray-500 capitalize">${fix.priority}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                        <!-- Completed Section -->
                        ${analysis.completedItems.length > 0 ? `
                        <div class="suggestion-card">
                            <div class="mb-4">
                                <h4 class="font-bold text-lg text-green-600 mb-2"> COMPLETED</h4>
                                <p class="text-gray-600 text-sm">Great job! You've already implemented these best practices.</p>
                            </div>
                            <div class="space-y-3">
                                ${analysis.completedItems.map(item => `
                                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800">${item.name}</div>
                                                <div class="text-sm text-gray-600">${item.message}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-medium text-green-600">${item.score}/10</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                        <!-- Steps to Increase Score -->
                        <div class="suggestion-card">
                            <div class="mb-4">
                                <h4 class="font-bold text-lg text-gray-800 mb-2">Steps to increase your score</h4>
                                <p class="text-gray-600 text-sm">Here are some recruiter checks that are bringing your score down. Click into each to learn where you went wrong and how to improve your score.</p>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-bold text-gray-800">${analysis.wordCount}</div>
                                    <div class="text-xs text-gray-500">Words</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-bold text-gray-800">${analysis.sectionCount}</div>
                                    <div class="text-xs text-gray-500">Sections</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-bold text-gray-800">${Math.round(analysis.readabilityScore)}</div>
                                    <div class="text-xs text-gray-500">Readability</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-bold text-gray-800">${analysis.topFixes.length + analysis.completedItems.length}</div>
                                    <div class="text-xs text-gray-500">Checks</div>
                                </div>
                            </div>
                        </div>`;

                    // Add sentence improvement suggestions with modern UI
                    const sentenceImprovements = suggestions.filter(s => s.type === 'sentence-improvement');
                    if (sentenceImprovements.length > 0) {
                        feedback += `
                        <div class="suggestion-card">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-lg flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </div>
                                    AI Sentence Rewrites
                                </h4>
                                <div class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded">${sentenceImprovements.length} suggestions</div>
                            </div>
                            <div class="space-y-4">
                                ${sentenceImprovements.map((s, index) => `
                                    <div class="bg-white p-4 rounded-lg border border-purple-200 hover:border-purple-300 transition-colors">
                                        <div class="flex items-start justify-between mb-3">
                                            <p class="text-sm font-medium text-purple-900 flex items-center">
                                                <span class="w-5 h-5 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">${index + 1}</span>
                                                ${s.message}
                                            </p>
                                        </div>
                                        <div class="space-y-3">
                                            <div class="relative">
                                                <div class="absolute -left-2 top-2 w-1 h-6 bg-red-400 rounded"></div>
                                                <div class="bg-red-50 border border-red-200 p-3 rounded-lg ml-2">
                                                    <div class="text-xs font-medium text-red-700 mb-1">BEFORE</div>
                                                    <div class="text-sm text-red-800">${SecurityUtils.sanitizeHTML(s.original)}</div>
                                                </div>
                                            </div>
                                            <div class="relative">
                                                <div class="absolute -left-2 top-2 w-1 h-6 bg-green-400 rounded"></div>
                                                <div class="bg-green-50 border border-green-200 p-3 rounded-lg ml-2">
                                                    <div class="text-xs font-medium text-green-700 mb-1">AFTER (AI IMPROVED)</div>
                                                    <div class="text-sm text-green-800">${SecurityUtils.sanitizeHTML(s.improved.replace(/\[.*?\]/g, ''))}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-4 flex justify-between items-center">
                                            <div class="flex space-x-2">
                                                <button onclick="applySuggestion('${SecurityUtils.sanitizeHTML(s.original)}', '${SecurityUtils.sanitizeHTML(s.improved.replace(/\[.*?\]/g, ''))}')" 
                                                        class="btn btn-primary text-xs animate-pulse-glow">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    Apply Change
                                                </button>
                                                <button onclick="rewriteWithContext('${SecurityUtils.sanitizeHTML(s.original)}', 'leadership')" 
                                                        class="btn btn-secondary text-xs">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                    </svg>
                                                    AI Rewrite
                                                </button>
                                            </div>
                                            <div class="text-xs text-gray-500">Impact: High</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }

                    // Add quantification suggestions
                    const quantificationSuggestions = suggestions.filter(s => s.type === 'quantification');
                    if (quantificationSuggestions.length > 0) {
                        feedback += `
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-orange-900 mb-2"> Add Metrics & Numbers</h4>
                            <div class="space-y-2">
                                ${quantificationSuggestions.map(s => `
                                    <div class="text-sm">
                                        <p class="font-medium">${s.message}</p>
                                        <p class="text-orange-700 italic">"${s.original}"</p>
                                        <p class="text-xs text-orange-600 mt-1">${s.suggestion}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }

                    // Add other suggestions
                    const otherSuggestions = suggestions.filter(s => !['sentence-improvement', 'quantification'].includes(s.type));
                    if (otherSuggestions.length > 0) {
                        feedback += `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-900 mb-2"> Smart Suggestions</h4>
                            ${otherSuggestions.map(s => `
                                <div class="mb-2">
                                    <p class="text-sm font-medium">${s.message}:</p>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${s.suggestions ? s.suggestions.map(suggestion => `<span class="bg-green-200 text-green-800 px-2 py-1 rounded text-xs cursor-pointer hover:bg-green-300" onclick="addSuggestionToResume('${suggestion}')">${suggestion}</span>`).join('') : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }

                    // Add general suggestions
                    if (analysis.suggestions.length > 0) {
                        feedback += `
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-900 mb-2"> General Improvements</h4>
                            <ul class="text-sm space-y-1">
                                ${analysis.suggestions.map(s => `<li> ${s}</li>`).join('')}
                            </ul>
                        </div>`;
                    }

                    feedback += `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 mb-2"> Best Practices</h4>
                            <ul class="text-sm space-y-1 text-gray-700">
                                <li> Use action verbs to start bullet points</li>
                                <li> Quantify achievements with numbers</li>
                                <li> Keep it to 1-2 pages maximum</li>
                                <li> Use consistent formatting throughout</li>
                                <li> Tailor content to the job description</li>
                            </ul>
                        </div>
                        
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-indigo-900 mb-2"> AI Rewrite Assistant</h4>
                            <p class="text-sm text-indigo-700 mb-2">Select any text in your resume and click below for AI-powered rewriting:</p>
                            <button onclick="rewriteSelectedText()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                                Rewrite Selected Text
                            </button>
                        </div>
                    </div>
                `;

                    aiFeedbackEl.innerHTML = feedback;

                } catch (error) {
                    console.error('Error in AI analysis:', error);
                    clearInterval(progressInterval);
                    progressIndicator.classList.add('hidden');
                    aiFeedbackEl.innerHTML = `
                        <div class="suggestion-card">
                            <div class="flex items-center justify-center p-8">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Analysis Error</h3>
                                    <p class="text-gray-600 mb-4">We encountered an error while analyzing your resume. Please try again.</p>
                                    <button onclick="handleAiAnalysis()" class="btn btn-primary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    showNotification('Analysis failed. Please try again.', 'error');
                }
            };

            // Override the existing AI analysis function
            document.addEventListener('click', e => {
                if (e.target.id === 'ai-analyze-btn') {
                    e.preventDefault();
                    handleAiAnalysis();
                }
            });

            // Fix the original renderAll function to ensure it's called properly
            const originalRenderAll = renderAll;
            renderAll = function () {
                try {
                    originalRenderAll();
                    // Re-add drag handles after each render
                    setTimeout(() => {
                        addDragHandles();
                    }, 50);
                } catch (error) {
                    console.error('Error in renderAll:', error);
                }
            };

            // Ensure handleInput includes auto-save
            const originalHandleInput = handleInput;
            handleInput = function (e) {
                try {
                    originalHandleInput.call(this, e);
                    scheduleAutoSave();
                } catch (error) {
                    console.warn('Error in handleInput:', error);
                }
            };

            // Add drag handles to section cards
            function addDragHandles() {
                const sectionCards = document.querySelectorAll('.section-card');
                sectionCards.forEach(card => {
                    if (!card.querySelector('.drag-handle')) {
                        const header = card.querySelector('.card-header .flex');
                        if (header) {
                            const dragHandle = document.createElement('div');
                            dragHandle.className = 'drag-handle ml-2 cursor-grab';
                            dragHandle.innerHTML = `
                                <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                </svg>
                            `;
                            header.appendChild(dragHandle);
                        }
                    }
                });
            }

            // Helper functions for AI suggestions
            window.applySuggestion = function (original, improved) {
                // Find and replace the original text in the resume
                const resumeElements = document.querySelectorAll('[contenteditable="true"]');
                resumeElements.forEach(element => {
                    if (element.innerHTML.includes(original)) {
                        element.innerHTML = element.innerHTML.replace(original, improved);
                        // Update the data
                        const path = element.dataset.path;
                        if (path) {
                            setNestedValue(resumeData, path, element.innerHTML);
                            updateCorrespondingElement(path, element.innerHTML, element);
                        }
                        showNotification('Suggestion applied successfully!', 'success');
                    }
                });
            };

            window.addSuggestionToResume = function (suggestion) {
                // Add skill or suggestion to the appropriate section
                const skillsSection = resumeData.sections.find(s => s.title.toLowerCase().includes('skill'));
                if (skillsSection && skillsSection.items.length > 0) {
                    const lastItem = skillsSection.items[skillsSection.items.length - 1];
                    if (lastItem.content) {
                        lastItem.content += `, ${suggestion}`;
                        renderAll();
                        showNotification(`Added "${suggestion}" to skills section!`, 'success');
                    }
                } else {
                    showNotification(`Copy "${suggestion}" and add it to your resume manually`, 'info');
                }
            };

            window.rewriteSelectedText = async function () {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                if (!selectedText) {
                    showNotification('Please select some text first', 'warning');
                    return;
                }

                if (selectedText.length < 10) {
                    showNotification('Please select a longer text (at least 10 characters)', 'warning');
                    return;
                }

                try {
                    showNotification('AI is rewriting your text...', 'info');
                    const rewritten = await rewriteSentenceWithAI(selectedText);

                    // Show the rewrite in a modal or replace directly
                    const confirmed = confirm(`Original: "${selectedText}"\n\nAI Rewrite: "${rewritten}"\n\nApply this change?`);

                    if (confirmed) {
                        // Replace the selected text
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(document.createTextNode(rewritten));

                        // Update the data
                        const element = range.commonAncestorContainer.parentElement;
                        if (element && element.dataset.path) {
                            setNestedValue(resumeData, element.dataset.path, element.innerHTML);
                            updateCorrespondingElement(element.dataset.path, element.innerHTML, element);
                        }

                        showNotification('Text rewritten successfully!', 'success');
                    }
                } catch (error) {
                    showNotification('Error rewriting text: ' + error.message, 'error');
                }
            };

            // Auto-save is already handled above

            // --- INITIAL RENDER ---
            try {
                console.log('Starting initial render...');

                // Load auto-saved data first
                const autoSavedData = localStorage.getItem('resumeBuilder_autoSave');
                if (autoSavedData) {
                    try {
                        const savedData = JSON.parse(autoSavedData);
                        resumeData = { ...resumeData, ...savedData };
                        console.log('Auto-saved data loaded');
                    } catch (error) {
                        console.warn('Could not load auto-saved data:', error);
                    }
                }

                // Initial render
                renderAll();

                // Initialize features after render
                setTimeout(() => {
                    try {
                        addDragHandles();
                        initializeDragDrop();
                        showNotification('Resume Builder loaded! Use Ctrl+S to save, Ctrl+E to export.', 'info');
                    } catch (error) {
                        console.error('Error initializing features:', error);
                    }
                }, 100);

            } catch (error) {
                console.error('Critical error during initialization:', error);
                // Fallback: show a basic error message
                if (formContainer) {
                    formContainer.innerHTML = '<div class="p-4 bg-red-100 text-red-700 rounded">Error loading resume builder. Please refresh the page.</div>';
                }
            }
        });
    </script>
</body>

</html>